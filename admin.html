<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bingo Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cabin+Condensed:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-body: #342e25;
      --bg-tile: #494034;
      --bg-well: #342e25;
      --bg-completed: #1e3a1e;
      --bg-completed-well: #162a16;
      --border-main: #6d604e;
      --border-completed: #4caf50;
      --accent: #ffac00;
      --text-main: #ffac00;
      --text-bright: #ffee00;
      --text-dim: #858476;
      --text-completed: #4caf50;
      --danger: #ff6d6d;
      --bg-card: #494035;
      --border-hover: #e94560;
      --accent-secondary: #0f9b8e;
      --gold: #ffd700;
      --silver: #c0c0c0;
      --bronze: #cd7f32;
    }

    * { box-sizing: border-box; }
    html { scrollbar-gutter: stable; overflow-y: scroll; }

    .sr-only {
      position: absolute !important; width: 1px; height: 1px;
      padding: 0; margin: -1px; overflow: hidden;
      clip: rect(0,0,0,0); border: 0; white-space: nowrap;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-well); }
    ::-webkit-scrollbar-thumb { background: var(--bg-card); border: 2px solid var(--bg-well); }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-main); }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: 'Cabin Condensed', sans-serif;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
        /* --- Admin Header --- */
    .admin-header {
      width: 100%; max-width: 1400px;
      background: var(--bg-card); border: 2px solid var(--border-main);
      padding: 20px 30px; margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    .admin-header-left { display: flex; flex-direction: column; gap: 2px; }

    .admin-title {
      font-size: 2rem; margin: 0; font-weight: bold;
      color: var(--accent); text-transform: uppercase;
      letter-spacing: 2px; text-shadow: 2px 2px 6px rgba(0,0,0,0.6);
    }

    .admin-subtitle {
      font-size: 0.9rem; color: var(--text-dim); margin: 0;
    }

    .admin-header-right {
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    }

    .admin-btn {
      background: var(--bg-well); border: 2px solid var(--border-main);
      color: var(--text-main); padding: 8px 18px;
      font-family: 'Cabin Condensed', sans-serif; font-size: 0.9rem;
      cursor: pointer; border-radius: 4px; transition: all 0.2s ease;
      text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
    }
    .admin-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--bg-card); }
    .admin-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .admin-btn svg { width: 16px; height: 16px; fill: currentColor; }

    .admin-btn.primary { border-color: var(--accent); color: var(--accent); }
    .admin-btn.primary:hover { background: var(--accent); color: var(--bg-body); }

    /* --- Global Stats Bar --- */
    .global-stats {
      width: 100%; max-width: 1400px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px; margin-bottom: 24px;
    }

    .global-stat-card {
      background: var(--bg-card); border: 2px solid var(--border-main);
      padding: 16px 20px; text-align: center;
      transition: border-color 0.2s ease;
    }
    .global-stat-card:hover { border-color: var(--accent); }
    .global-stat-label {
      font-size: 0.65rem; text-transform: uppercase;
      letter-spacing: 1px; color: var(--text-dim); margin-bottom: 4px;
    }
    .global-stat-value {
      font-size: 1.8rem; font-weight: bold; color: var(--text-bright);
    }
    .global-stat-value.accent { color: var(--accent); }
    .global-stat-value.green { color: var(--text-completed); }

    /* --- Leaderboard --- */
    .leaderboard-section {
      width: 100%; max-width: 1400px; margin-bottom: 24px;
    }

    .section-title {
      font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px;
      color: var(--text-dim); margin-bottom: 12px; padding-bottom: 6px;
      border-bottom: 1px solid var(--border-main);
      display: flex; align-items: center; gap: 8px;
    }
    .section-title svg { width: 18px; height: 18px; fill: var(--text-dim); }

    .leaderboard-table {
      width: 100%; border-collapse: collapse;
      background: var(--bg-card); border: 2px solid var(--border-main);
    }
    .leaderboard-table th {
      background: var(--bg-well); color: var(--text-dim);
      font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
      padding: 10px 16px; text-align: left; border-bottom: 2px solid var(--border-main);
    }
    .leaderboard-table td {
      padding: 12px 16px; border-bottom: 1px solid var(--border-main);
      font-size: 0.95rem; vertical-align: middle;
    }
    .leaderboard-table tr:last-child td { border-bottom: none; }
    .leaderboard-table tr:hover td { background: rgba(233, 69, 96, 0.05); }

    .rank-badge {
      display: inline-flex; align-items: center; justify-content: center;
      width: 28px; height: 28px; border-radius: 50%;
      font-weight: bold; font-size: 0.85rem;
      border: 2px solid var(--border-main); color: var(--text-dim);
    }
    .rank-badge.gold { border-color: var(--gold); color: var(--gold); background: rgba(255,215,0,0.1); }
    .rank-badge.silver { border-color: var(--silver); color: var(--silver); background: rgba(192,192,192,0.08); }
    .rank-badge.bronze { border-color: var(--bronze); color: var(--bronze); background: rgba(205,127,50,0.08); }

    .team-name-cell {
      display: flex; align-items: center; gap: 10px;
    }
    .team-color-dot {
      width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .team-name-link {
      color: var(--text-bright); text-decoration: none; font-weight: bold;
      transition: color 0.2s ease;
    }
    .team-name-link:hover { color: var(--accent); text-decoration: underline; }

    .progress-bar-cell { min-width: 120px; }
    .lb-progress-bg {
      background: var(--bg-well); height: 8px; border-radius: 4px;
      overflow: hidden; border: 1px solid rgba(0,0,0,0.3);
    }
    .lb-progress-fill {
      height: 100%; border-radius: 4px;
      transition: width 0.5s ease;
    }
    .points-cell { font-weight: bold; color: var(--accent); font-size: 1.1rem; }
    .completed-cell { color: var(--text-completed); font-weight: bold; }
        /* --- Team Cards Grid --- */
    .teams-section {
      width: 100%; max-width: 1400px; margin-bottom: 24px;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .team-card {
      background: var(--bg-card); border: 2px solid var(--border-main);
      padding: 0; cursor: pointer;
      transition: all 0.3s ease; position: relative; overflow: hidden;
      text-decoration: none; color: inherit; display: flex; flex-direction: column;
    }
    .team-card:hover {
      border-color: var(--accent); transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(233, 69, 96, 0.2);
    }
    .team-card:focus-visible { outline: 3px solid var(--accent); outline-offset: 2px; }

    .team-card-header {
      padding: 16px 20px; display: flex; justify-content: space-between;
      align-items: center; border-bottom: 1px solid var(--border-main);
    }
    .team-card-name {
      font-size: 1.2rem; font-weight: bold; color: var(--text-bright);
      display: flex; align-items: center; gap: 8px;
    }
    .team-card-rank {
      font-size: 0.75rem; color: var(--text-dim);
      background: var(--bg-well); padding: 2px 8px; border-radius: 10px;
      border: 1px solid var(--border-main);
    }

    .team-card-body { padding: 16px 20px; flex: 1; }

    .team-card-stats {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px;
    }
    .tc-stat-label {
      font-size: 0.6rem; text-transform: uppercase;
      color: var(--text-dim); letter-spacing: 0.5px;
    }
    .tc-stat-value { font-size: 1.3rem; font-weight: bold; }
    .tc-stat-value.points { color: var(--accent); }
    .tc-stat-value.completed { color: var(--text-completed); }

    .team-card-progress { margin-bottom: 14px; }
    .tc-progress-label {
      display: flex; justify-content: space-between;
      font-size: 0.7rem; color: var(--text-dim); margin-bottom: 4px;
    }
    .tc-progress-bg {
      background: var(--bg-well); height: 10px; border-radius: 5px;
      overflow: hidden; border: 1px solid rgba(0,0,0,0.3);
    }
    .tc-progress-fill {
      height: 100%; border-radius: 5px; transition: width 0.5s ease;
    }

    /* Mini board preview */
    .team-card-miniboard {
      display: grid; grid-template-columns: repeat(7, 1fr);
      gap: 2px; padding: 8px; background: var(--bg-well);
      border: 1px solid rgba(0,0,0,0.3); border-radius: 3px;
    }
    .tc-mini-tile {
      aspect-ratio: 1; background: var(--bg-body);
      border-radius: 1px; transition: background 0.3s ease;
    }
    .tc-mini-tile.complete { background: var(--text-completed); }

    .team-card-footer {
      padding: 10px 20px; border-top: 1px solid var(--border-main);
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.75rem; color: var(--text-dim);
    }
    .team-card-footer .view-link {
      color: var(--accent); font-weight: bold; text-transform: uppercase;
      letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px;
    }
    .team-card-footer .view-link svg { width: 14px; height: 14px; fill: currentColor; }

    /* --- Activity / Event Log --- */
    .activity-section {
      width: 100%; max-width: 1400px; margin-bottom: 24px;
    }

    .activity-list {
      background: var(--bg-card); border: 2px solid var(--border-main);
      max-height: 300px; overflow-y: auto;
    }
    .activity-item {
      padding: 10px 16px; border-bottom: 1px solid var(--border-main);
      display: flex; align-items: center; gap: 12px; font-size: 0.85rem;
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-item:hover { background: rgba(255,255,255,0.02); }

    .activity-icon {
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; font-size: 0.9rem;
    }
    .activity-icon.tile-complete { background: rgba(76,175,80,0.15); color: var(--text-completed); }
    .activity-icon.points { background: rgba(233,69,96,0.15); color: var(--accent); }
    .activity-icon.event { background: rgba(15,155,142,0.15); color: var(--accent-secondary); }

    .activity-text { flex: 1; }
    .activity-text strong { color: var(--text-bright); }
    .activity-time { font-size: 0.7rem; color: var(--text-dim); flex-shrink: 0; }

    /* --- Footer --- */
    .admin-footer {
      width: 100%; max-width: 1400px;
      padding: 15px 0 10px 0; font-size: 0.65rem;
      color: var(--border-main);
      display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
    }
    .admin-footer .sync-btn {
      cursor: pointer; color: var(--text-dim); text-decoration: underline;
    }
    .admin-footer .sync-btn:hover { color: var(--accent); }

    .sync-flash { animation: flash-sync 1s ease-out; }
    @keyframes flash-sync { 0% { color: var(--accent); } 100% { color: var(--border-main); } }
    .sync-error { color: var(--danger); }

    /* --- Responsive --- */
    @media (max-width: 900px) {
      .admin-header { padding: 14px 18px; }
      .admin-title { font-size: 1.4rem; }
      .teams-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
      .leaderboard-table th, .leaderboard-table td { padding: 8px 10px; font-size: 0.85rem; }
    }

    @media (max-width: 600px) {
      body { padding: 10px; }
      .admin-header { flex-direction: column; align-items: flex-start; }
      .admin-title { font-size: 1.2rem; }
      .global-stats { grid-template-columns: repeat(2, 1fr); }
      .teams-grid { grid-template-columns: 1fr; }
      .leaderboard-table { font-size: 0.8rem; }
      .leaderboard-table th:nth-child(4),
      .leaderboard-table td:nth-child(4) { display: none; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
      .team-card:hover { transform: none !important; }
    }
  </style>
</head>
<body>
  <!-- Admin Header -->
  <header class="admin-header">
    <div class="admin-header-left">
      <h1 class="admin-title">⬡ Bingo Command Center</h1>
      <p class="admin-subtitle" id="event-subtitle">Event: Bingo 2026 &middot; Loading...</p>
    </div>
    <div class="admin-header-right">
      <a href="settings.html" class="admin-btn primary">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z M12 15.6A3.6 3.6 0 1115.6 12 3.611 3.611 0 0112 15.6z"/></svg>
        Game Settings
      </a>
      <button class="admin-btn" id="refresh-all-btn">
        <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        Refresh All
      </button>
    </div>
  </header>

  <!-- Global Stats -->
  <div class="global-stats" id="global-stats">
    <div class="global-stat-card">
      <div class="global-stat-label">Total Teams</div>
      <div class="global-stat-value accent" id="stat-total-teams">0</div>
    </div>
    <div class="global-stat-card">
      <div class="global-stat-label">Total Tiles Completed</div>
      <div class="global-stat-value green" id="stat-total-completed">0</div>
    </div>
    <div class="global-stat-card">
      <div class="global-stat-label">Total Points Awarded</div>
      <div class="global-stat-value accent" id="stat-total-points">0</div>
    </div>
    <div class="global-stat-card">
      <div class="global-stat-label">Avg Completion</div>
      <div class="global-stat-value" id="stat-avg-completion">0%</div>
    </div>
    <div class="global-stat-card">
      <div class="global-stat-label">Leading Team</div>
      <div class="global-stat-value" id="stat-leading-team" style="font-size:1.1rem;">-</div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="leaderboard-section">
    <div class="section-title">
      <svg viewBox="0 0 24 24"><path d="M7.5 21H2V9h5.5v12zm7.25-18h-5.5v18h5.5V3zM22 11h-5.5v10H22V11z"/></svg>
      Leaderboard
    </div>
    <table class="leaderboard-table" id="leaderboard-table">
      <thead>
        <tr>
          <th style="width:50px;">Rank</th>
          <th>Team</th>
          <th style="width:100px;">Points</th>
          <th style="width:160px;">Progress</th>
          <th style="width:90px;">Completed</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>

  <!-- Team Cards -->
  <div class="teams-section">
    <div class="section-title">
      <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
      Team Boards
    </div>
    <div class="teams-grid" id="teams-grid"></div>
  </div>

  <!-- Recent Activity -->
  <div class="activity-section">
    <div class="section-title">
      <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 00-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0013 21a9 9 0 000-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
      Recent Activity
    </div>
    <div class="activity-list" id="activity-list">
      <div class="activity-item">
        <div class="activity-icon event">⏳</div>
        <div class="activity-text">Waiting for data...</div>
        <div class="activity-time">-</div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="admin-footer">
    <span>Admin Dashboard v1.0</span>
    <span>&middot;</span>
    <span id="admin-last-sync" aria-live="polite">Last Sync: Never</span>
    <span class="sync-btn" id="admin-sync-now" role="button" tabindex="0">[Sync Now]</span>
  </footer>
    <script>
(() => {
  const MAX_TILES = 49;
  const BOARD_PAGE = 'index.html';

  /*
    TEAM_MAP: Up to 8 teams.
    Each entry needs:
      - name: Display name
      - url: Published Google Sheet CSV URL
      - color: Hex color for the team dot / accent
      - codeword: (optional)
      - points: Starting/total points override
  */
  const TEAM_MAP = {
    Warriors: {
      name: "The Spreadsheet Warriors",
      url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRFOGe_j8BL0X5Cwvy3LNmsrWG82IAXlWpump0Sw6PKWLz-1gxbisdbPuTmJ_CmjLA_q-Q6y9jTfFwq/pub?gid=1593254680&single=true&output=csv",
      color: "#e94560",
      codeword: "BINGO_BLITZ",
      points: 1250
    },
    Legends: {
      name: "The Lucky Legends",
      url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRFOGe_j8BL0X5Cwvy3LNmsrWG82IAXlWpump0Sw6PKWLz-1gxbisdbPuTmJ_CmjLA_q-Q6y9jTfFwq/pub?gid=1593254680&single=true&output=csv",
      color: "#0f9b8e",
      codeword: "LUCKY_STRIKE",
      points: 980
    },
    Titans: {
      name: "The Tile Titans",
      url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRFOGe_j8BL0X5Cwvy3LNmsrWG82IAXlWpump0Sw6PKWLz-1gxbisdbPuTmJ_CmjLA_q-Q6y9jTfFwq/pub?gid=1593254680&single=true&output=csv",
      color: "#ffd700",
      codeword: "TITAN_POWER",
      points: 870
    },
    Nomads: {
      name: "The Bingo Nomads",
      url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRFOGe_j8BL0X5Cwvy3LNmsrWG82IAXlWpump0Sw6PKWLz-1gxbisdbPuTmJ_CmjLA_q-Q6y9jTfFwq/pub?gid=1593254680&single=true&output=csv",
      color: "#a855f7",
      codeword: "WANDERER",
      points: 640
    }
  };

  let teamData = {};   // { key: { tiles[], completion[], completedCount, totalPercent } }
  let syncIntervalId = null;
  const syncMs = 30000;

  const $ = (id) => document.getElementById(id);
  const DOM = {
    eventSubtitle: $('event-subtitle'),
    totalTeams: $('stat-total-teams'),
    totalCompleted: $('stat-total-completed'),
    totalPoints: $('stat-total-points'),
    avgCompletion: $('stat-avg-completion'),
    leadingTeam: $('stat-leading-team'),
    leaderboardBody: $('leaderboard-body'),
    teamsGrid: $('teams-grid'),
    activityList: $('activity-list'),
    lastSync: $('admin-last-sync'),
    syncNow: $('admin-sync-now'),
    refreshAll: $('refresh-all-btn'),
  };
    const normalizeNL = (s) => String(s).replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const escapeHTML = (str) => {
    const d = document.createElement('div');
    d.appendChild(document.createTextNode(String(str ?? '')));
    return d.innerHTML;
  };

  const parseCSVRow = (row) => {
    const cols = []; let cur = '', inQ = false;
    for (let i = 0; i < row.length; i++) {
      const ch = row[i];
      if (inQ) {
        if (ch === '"' && row[i + 1] === '"') { cur += '"'; i++; }
        else if (ch === '"') inQ = false;
        else cur += ch;
      } else {
        if (ch === '"') inQ = true;
        else if (ch === ',') { cols.push(cur.trim()); cur = ''; }
        else cur += ch;
      }
    }
    cols.push(cur.trim());
    return cols;
  };

  const getProgressColor = (pct) => {
    if (pct >= 100) return '#4caf50';
    const hue = (pct * 120) / 100;
    return `hsl(${hue}, 70%, 45%)`;
  };

  const rankColors = ['gold', 'silver', 'bronze'];

  const flashSync = () => {
    DOM.lastSync.classList.remove('sync-error');
    DOM.lastSync.innerText = `Last Sync: ${new Date().toLocaleTimeString()}`;
    DOM.lastSync.classList.remove('sync-flash');
    void DOM.lastSync.offsetWidth;
    DOM.lastSync.classList.add('sync-flash');
  };
    /* ========================= FETCH TEAM DATA ========================= */
  async function fetchTeamData(teamKey) {
    const team = TEAM_MAP[teamKey];
    try {
      const res = await fetch(`${team.url}&t=${Date.now()}`, {
        headers: { 'pragma': 'no-cache', 'cache-control': 'no-cache' }
      });
      const raw = normalizeNL(await res.text());
      const rows = raw.split('\n').slice(1);
      const tiles = [];
      const completion = Array(MAX_TILES).fill(false);
      let count = 0;

      for (const line of rows) {
        if (count >= MAX_TILES) break;
        if (!line || !line.trim()) continue;
        const cols = parseCSVRow(line.trim());
        if (cols.length < 4) continue;
        const current = Math.max(0, parseInt(cols[2], 10) || 0);
        const goal = Math.max(1, parseInt(cols[3], 10) || 1);
        const percent = Math.min((current / goal) * 100, 100);
        const isCompleted = percent === 100;
        const points = cols[6] || '0';
        completion[count] = isCompleted;
        tiles.push({ title: cols[0] || `Tile ${count+1}`, percent, isCompleted, points });
        count++;
      }

      const completedCount = completion.filter(Boolean).length;
      const totalPercent = count > 0
        ? tiles.reduce((sum, t) => sum + t.percent, 0) / count
        : 0;

      teamData[teamKey] = { tiles, completion, completedCount, totalPercent, tileCount: count };

    } catch (e) {
      console.error(`Error fetching ${teamKey}:`, e);
      if (!teamData[teamKey]) {
        teamData[teamKey] = {
          tiles: [], completion: Array(MAX_TILES).fill(false),
          completedCount: 0, totalPercent: 0, tileCount: 0
        };
      }
    }
  }

  async function fetchAllTeams() {
    const keys = Object.keys(TEAM_MAP);
    await Promise.allSettled(keys.map(k => fetchTeamData(k)));
    flashSync();
    renderAll();
  }

  /* ========================= RENDER ========================= */
  function getSortedTeams() {
    return Object.keys(TEAM_MAP).sort((a, b) => {
      const pa = Number(TEAM_MAP[a].points || 0);
      const pb = Number(TEAM_MAP[b].points || 0);
      if (pb !== pa) return pb - pa;
      const ca = teamData[a]?.completedCount || 0;
      const cb = teamData[b]?.completedCount || 0;
      return cb - ca;
    });
  }

  function renderGlobalStats(sorted) {
    const keys = Object.keys(TEAM_MAP);
    const totalTeams = keys.length;
    let totalCompleted = 0;
    let totalPoints = 0;
    let totalPercent = 0;

    for (const k of keys) {
      totalCompleted += teamData[k]?.completedCount || 0;
      totalPoints += Number(TEAM_MAP[k].points || 0);
      totalPercent += teamData[k]?.totalPercent || 0;
    }

    DOM.totalTeams.innerText = totalTeams;
    DOM.totalCompleted.innerText = totalCompleted;
    DOM.totalPoints.innerText = totalPoints.toLocaleString();
    DOM.avgCompletion.innerText = totalTeams > 0
      ? Math.round(totalPercent / totalTeams) + '%' : '0%';

    if (sorted.length > 0) {
      DOM.leadingTeam.innerText = TEAM_MAP[sorted[0]].name;
      DOM.leadingTeam.style.color = TEAM_MAP[sorted[0]].color;
    }

    DOM.eventSubtitle.innerText = `Event: Bingo 2026 · ${totalTeams} Teams · ${totalCompleted} Tiles Completed`;
  }

  function renderLeaderboard(sorted) {
    DOM.leaderboardBody.innerHTML = '';
    const frag = document.createDocumentFragment();

    sorted.forEach((key, idx) => {
      const team = TEAM_MAP[key];
      const data = teamData[key] || { completedCount: 0, totalPercent: 0 };
      const rank = idx + 1;
      const rankClass = idx < 3 ? rankColors[idx] : '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="rank-badge ${rankClass}">${rank}</span></td>
        <td>
          <div class="team-name-cell">
            <div class="team-color-dot" style="background:${team.color};"></div>
            <a href="${BOARD_PAGE}?team=${encodeURIComponent(key)}" class="team-name-link">${escapeHTML(team.name)}</a>
          </div>
        </td>
        <td class="points-cell">${Number(team.points || 0).toLocaleString()}</td>
        <td class="progress-bar-cell">
          <div class="lb-progress-bg">
            <div class="lb-progress-fill" style="width:${Math.round(data.totalPercent)}%; background:${getProgressColor(data.totalPercent)};"></div>
          </div>
        </td>
        <td class="completed-cell">${data.completedCount}/${MAX_TILES}</td>
      `;
      frag.appendChild(tr);
    });

    DOM.leaderboardBody.appendChild(frag);
  }

  function renderTeamCards(sorted) {
    DOM.teamsGrid.innerHTML = '';
    const frag = document.createDocumentFragment();

    sorted.forEach((key, idx) => {
      const team = TEAM_MAP[key];
      const data = teamData[key] || { completedCount: 0, totalPercent: 0, completion: Array(MAX_TILES).fill(false) };
      const rank = idx + 1;

      const card = document.createElement('a');
      card.className = 'team-card';
      card.href = `${BOARD_PAGE}?team=${encodeURIComponent(key)}`;
      card.setAttribute('role', 'link');
      card.setAttribute('aria-label', `View ${team.name} board`);

      // Build mini-tile grid
      let miniTiles = '';
      for (let i = 0; i < MAX_TILES; i++) {
        miniTiles += `<div class="tc-mini-tile${data.completion[i] ? ' complete' : ''}"></div>`;
      }

      card.innerHTML = `
        <div class="team-card-header">
          <div class="team-card-name">
            <div class="team-color-dot" style="background:${team.color};"></div>
            ${escapeHTML(team.name)}
          </div>
          <div class="team-card-rank">#${rank}</div>
        </div>
        <div class="team-card-body">
          <div class="team-card-stats">
            <div>
              <div class="tc-stat-label">Points</div>
              <div class="tc-stat-value points">${Number(team.points || 0).toLocaleString()}</div>
            </div>
            <div>
              <div class="tc-stat-label">Completed</div>
              <div class="tc-stat-value completed">${data.completedCount}/${MAX_TILES}</div>
            </div>
          </div>
          <div class="team-card-progress">
            <div class="tc-progress-label">
              <span>Overall Progress</span>
              <span>${Math.round(data.totalPercent)}%</span>
            </div>
            <div class="tc-progress-bg">
              <div class="tc-progress-fill" style="width:${Math.round(data.totalPercent)}%; background:${getProgressColor(data.totalPercent)};"></div>
            </div>
          </div>
          <div class="team-card-miniboard">${miniTiles}</div>
        </div>
        <div class="team-card-footer">
          <span>Last synced just now</span>
          <span class="view-link">
            View Board
            <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
          </span>
        </div>
      `;

      frag.appendChild(card);
    });

    DOM.teamsGrid.appendChild(frag);
  }

  function renderActivity(sorted) {
    DOM.activityList.innerHTML = '';
    const frag = document.createDocumentFragment();
    const activities = [];

    for (const key of sorted) {
      const team = TEAM_MAP[key];
      const data = teamData[key];
      if (!data) continue;

      if (data.completedCount > 0) {
        activities.push({
          icon: 'tile-complete', symbol: '✓',
          text: `<strong>${escapeHTML(team.name)}</strong> has completed <strong>${data.completedCount}</strong> tiles`,
          time: 'Recent'
        });
      }
      if (Number(team.points) > 0) {
        activities.push({
          icon: 'points', symbol: '★',
          text: `<strong>${escapeHTML(team.name)}</strong> has earned <strong>${Number(team.points).toLocaleString()}</strong> points`,
          time: 'Recent'
        });
      }
    }

    if (activities.length === 0) {
      activities.push({
        icon: 'event', symbol: '⏳',
        text: 'No activity yet. Waiting for teams to complete tiles...',
        time: '-'
      });
    }

    for (const act of activities) {
      const item = document.createElement('div');
      item.className = 'activity-item';
      item.innerHTML = `
        <div class="activity-icon ${act.icon}">${act.symbol}</div>
        <div class="activity-text">${act.text}</div>
        <div class="activity-time">${act.time}</div>
      `;
      frag.appendChild(item);
    }

    DOM.activityList.appendChild(frag);
  }

  function renderAll() {
    const sorted = getSortedTeams();
    renderGlobalStats(sorted);
    renderLeaderboard(sorted);
    renderTeamCards(sorted);
    renderActivity(sorted);
  }
    /* ========================= INIT ========================= */
  function init() {
    // Sync now
    DOM.syncNow.addEventListener('click', () => fetchAllTeams());
    DOM.syncNow.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fetchAllTeams(); }
    });
    DOM.refreshAll.addEventListener('click', () => fetchAllTeams());

    // Visibility pause
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (syncIntervalId) clearInterval(syncIntervalId);
        syncIntervalId = null;
      } else {
        syncIntervalId = setInterval(() => fetchAllTeams(), syncMs);
        fetchAllTeams();
      }
    });

    // Initial fetch
    fetchAllTeams();
    syncIntervalId = setInterval(() => fetchAllTeams(), syncMs);
  }

  init();
})();
  </script>
</body>
</html>