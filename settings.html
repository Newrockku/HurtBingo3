<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bingo - Game Settings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cabin+Condensed:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-body: #1a1a2e;
      --bg-card: #16213e;
      --bg-well: #0f1529;
      --border-main: #2a3a5c;
      --accent: #e94560;
      --accent-secondary: #0f9b8e;
      --text-main: #e0e0e0;
      --text-bright: #ffffff;
      --text-dim: #6a7a9b;
      --text-completed: #4caf50;
      --danger: #ff6d6d;
      --success: #4caf50;
      --warning: #ffc107;
    }

    * { box-sizing: border-box; }
    html { scrollbar-gutter: stable; overflow-y: scroll; }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-well); }
    ::-webkit-scrollbar-thumb { background: var(--bg-card); border: 2px solid var(--bg-well); }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-main); }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: 'Cabin Condensed', sans-serif;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
        /* --- Page Header --- */
    .page-header {
      width: 100%; max-width: 960px;
      background: var(--bg-card); border: 2px solid var(--border-main);
      padding: 20px 30px; margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    .page-header-left { display: flex; flex-direction: column; gap: 2px; }
    .page-title {
      font-size: 1.8rem; margin: 0; font-weight: bold;
      color: var(--accent); text-transform: uppercase;
      letter-spacing: 2px; text-shadow: 2px 2px 6px rgba(0,0,0,0.6);
    }
    .page-subtitle { font-size: 0.85rem; color: var(--text-dim); margin: 0; }

    .nav-btn {
      background: var(--bg-well); border: 2px solid var(--border-main);
      color: var(--text-main); padding: 8px 18px;
      font-family: 'Cabin Condensed', sans-serif; font-size: 0.9rem;
      cursor: pointer; border-radius: 4px; transition: all 0.2s ease;
      text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
    }
    .nav-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--bg-card); }
    .nav-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .nav-btn svg { width: 16px; height: 16px; fill: currentColor; }

    /* --- Settings Container --- */
    .settings-container {
      width: 100%; max-width: 960px;
      display: flex; flex-direction: column; gap: 20px;
      padding-bottom: 40px;
    }

    /* --- Collapsible Card --- */
    .settings-card {
      background: var(--bg-card); border: 2px solid var(--border-main);
      overflow: hidden; transition: border-color 0.2s ease;
    }
    .settings-card:hover { border-color: #3a4a6c; }

    .card-header {
      padding: 14px 20px; background: var(--bg-well);
      border-bottom: 2px solid var(--border-main);
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; user-select: none;
      transition: background 0.2s ease;
    }
    .card-header:hover { background: rgba(233,69,96,0.05); }
    .card-header:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; }
    .card-header svg { width: 20px; height: 20px; fill: var(--accent); flex-shrink: 0; }

    .card-title {
      font-size: 1.05rem; font-weight: bold; color: var(--text-bright);
      text-transform: uppercase; letter-spacing: 1px; flex: 1;
    }
    .card-badge {
      font-size: 0.65rem; background: var(--accent); color: #fff;
      padding: 2px 8px; border-radius: 10px; font-weight: bold;
    }
    .card-toggle {
      color: var(--text-dim); font-size: 1.2rem;
      transition: transform 0.3s ease; flex-shrink: 0;
    }
    .card-toggle.open { transform: rotate(180deg); }

    .card-body { padding: 20px; display: none; }
    .card-body.open { display: block; }

    /* --- Form Elements --- */
    .form-group { margin-bottom: 18px; display: flex; flex-direction: column; gap: 4px; }
    .form-group:last-child { margin-bottom: 0; }

    .form-label { font-size: 0.85rem; font-weight: bold; color: var(--text-bright); }
    .form-hint { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 2px; }
    .form-required { color: var(--accent); }

    .form-input, .form-select, .form-textarea {
      background: var(--bg-well); border: 1px solid var(--border-main);
      color: var(--text-bright); padding: 8px 12px;
      font-family: 'Cabin Condensed', sans-serif; font-size: 0.95rem;
      border-radius: 4px; transition: border-color 0.2s ease; width: 100%;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: var(--accent); outline: none;
    }
    .form-input.invalid, .form-textarea.invalid { border-color: var(--danger); }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-input.short { max-width: 180px; }
    .form-input.medium { max-width: 400px; }

    .form-row { display: flex; gap: 16px; flex-wrap: wrap; }
    .form-row .form-group { flex: 1; min-width: 200px; }

    .form-inline { display: flex; align-items: center; gap: 8px; }

    .color-swatch {
      width: 36px; height: 30px; border: 2px solid var(--border-main);
      border-radius: 3px; cursor: pointer; padding: 0; background: none;
      flex-shrink: 0;
    }
    .color-swatch:hover { border-color: var(--accent); }

    .form-checkbox-row {
      display: flex; align-items: center; gap: 8px; padding: 6px 0;
    }
    .form-checkbox-row input[type="checkbox"] {
      width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer;
    }
    .form-checkbox-label { font-size: 0.9rem; color: var(--text-bright); cursor: pointer; }
        /* --- Buttons --- */
    .form-actions { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }

    .btn {
      padding: 8px 20px; font-family: 'Cabin Condensed', sans-serif;
      font-size: 0.9rem; cursor: pointer; border-radius: 4px;
      border: 2px solid var(--border-main); transition: all 0.2s ease;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .btn-primary {
      background: var(--accent); border-color: var(--accent);
      color: #fff; font-weight: bold;
    }
    .btn-primary:hover { background: #c23152; border-color: #c23152; }

    .btn-secondary {
      background: var(--bg-well); border-color: var(--border-main); color: var(--text-main);
    }
    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

    .btn-danger {
      background: var(--bg-well); border-color: var(--danger); color: var(--danger);
    }
    .btn-danger:hover { background: var(--danger); color: #000; }

    .btn-success {
      background: var(--bg-well); border-color: var(--success); color: var(--success);
    }
    .btn-success:hover { background: var(--success); color: #000; }

    .btn-sm { padding: 4px 12px; font-size: 0.8rem; }

    /* --- Team Editor --- */
    .team-list { display: flex; flex-direction: column; gap: 12px; }

    .team-item {
      background: var(--bg-well); border: 1px solid var(--border-main);
      border-radius: 4px; overflow: hidden;
    }
    .team-item-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 16px; cursor: pointer; transition: background 0.2s ease;
    }
    .team-item-header:hover { background: rgba(233,69,96,0.04); }

    .team-item-name {
      font-weight: bold; color: var(--text-bright);
      display: flex; align-items: center; gap: 8px; font-size: 0.95rem;
    }
    .team-dot {
      width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .team-item-meta {
      font-size: 0.7rem; color: var(--text-dim);
      display: flex; align-items: center; gap: 8px;
    }
    .team-item-body { padding: 0 16px 16px 16px; display: none; }
    .team-item-body.open { display: block; }

    .team-item-actions {
      display: flex; gap: 6px; padding-top: 10px;
      border-top: 1px solid var(--border-main); margin-top: 12px;
    }

    .team-count-badge {
      font-size: 0.7rem; background: var(--bg-body);
      color: var(--text-dim); padding: 2px 8px; border-radius: 10px;
      border: 1px solid var(--border-main);
    }

    /* --- Variable Table --- */
    .var-table { width: 100%; border-collapse: collapse; }
    .var-table th {
      background: var(--bg-body); color: var(--text-dim);
      font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px;
      padding: 8px 12px; text-align: left;
      border-bottom: 2px solid var(--border-main);
    }
    .var-table td {
      padding: 8px 12px; border-bottom: 1px solid var(--border-main);
      font-size: 0.85rem; vertical-align: top;
    }
    .var-table tr:last-child td { border-bottom: none; }
    .var-table tr:hover td { background: rgba(233,69,96,0.03); }

    .var-key { font-weight: bold; color: var(--accent); font-family: monospace; font-size: 0.8rem; }
    .var-val { color: var(--text-bright); word-break: break-all; }
    .var-desc { color: var(--text-dim); font-size: 0.75rem; max-width: 260px; }
    .var-type {
      font-size: 0.6rem; text-transform: uppercase; font-weight: bold;
      padding: 1px 6px; border-radius: 3px; display: inline-block;
    }
    .var-type.string { background: rgba(15,155,142,0.15); color: var(--accent-secondary); }
    .var-type.number { background: rgba(233,69,96,0.15); color: var(--accent); }
    .var-type.boolean { background: rgba(255,193,7,0.15); color: var(--warning); }
    .var-type.url { background: rgba(100,130,200,0.15); color: #8090cc; }

    /* --- Import / Export --- */
    .io-area {
      width: 100%; min-height: 120px; max-height: 300px;
      background: var(--bg-body); border: 1px solid var(--border-main);
      color: var(--text-bright); font-family: 'Cabin Condensed', monospace;
      font-size: 0.75rem; padding: 10px; border-radius: 4px;
      resize: vertical; margin-top: 8px;
    }
    .io-area:focus { border-color: var(--accent); outline: none; }

    /* --- Toast --- */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: var(--bg-card); border: 2px solid var(--success);
      padding: 10px 28px; border-radius: 6px; color: var(--success);
      font-weight: bold; font-size: 0.9rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      opacity: 0; transition: opacity 0.3s ease;
      pointer-events: none; z-index: 9000;
    }
    .toast.error { border-color: var(--danger); color: var(--danger); }
    .toast.warning { border-color: var(--warning); color: var(--warning); }
    .toast.show { opacity: 1; }

    /* --- Page Footer --- */
    .page-footer {
      width: 100%; max-width: 960px;
      padding: 15px 0 10px 0; font-size: 0.65rem;
      color: var(--border-main);
      display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
    }

    /* --- Responsive --- */
    @media (max-width: 700px) {
      body { padding: 10px; }
      .page-header { flex-direction: column; align-items: flex-start; padding: 14px 18px; }
      .page-title { font-size: 1.3rem; }
      .form-row { flex-direction: column; }
      .form-row .form-group { min-width: 100%; }
      .var-table th:nth-child(4), .var-table td:nth-child(4) { display: none; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body>
  <!-- Page Header -->
  <header class="page-header">
    <div class="page-header-left">
      <h1 class="page-title">⚙ Game Settings</h1>
      <p class="page-subtitle">Configure event details, teams, board variables, and data sources</p>
    </div>
    <a href="admin.html" class="nav-btn">
      <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      Back to Dashboard
    </a>
  </header>

  <div class="settings-container">

    <!-- ===== EVENT CONFIGURATION ===== -->
    <div class="settings-card">
      <div class="card-header" tabindex="0" data-section="event" role="button" aria-expanded="true">
        <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg>
        <span class="card-title">Event Configuration</span>
        <span class="card-toggle open">▼</span>
      </div>
      <div class="card-body open" id="section-event">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="cfg-event-name">Event Name <span class="form-required">*</span></label>
            <div class="form-hint">Displayed on all boards and the admin dashboard</div>
            <input type="text" id="cfg-event-name" class="form-input medium" value="Bingo 2026" maxlength="50">
          </div>
          <div class="form-group">
            <label class="form-label" for="cfg-tile-count">Total Tiles</label>
            <div class="form-hint">Grid size (max 49 for 7×7)</div>
            <input type="number" id="cfg-tile-count" class="form-input short" value="49" min="1" max="49">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="cfg-start-date">Start Date</label>
            <input type="datetime-local" id="cfg-start-date" class="form-input medium">
          </div>
          <div class="form-group">
            <label class="form-label" for="cfg-end-date">End Date</label>
            <input type="datetime-local" id="cfg-end-date" class="form-input medium">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="cfg-description">Event Description</label>
          <div class="form-hint">Optional message displayed to participants</div>
          <textarea id="cfg-description" class="form-textarea" placeholder="Welcome to Bingo 2026! Complete tiles to earn points for your team."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="cfg-board-page">Board Page URL</label>
            <div class="form-hint">Filename or URL of the team board page</div>
            <input type="text" id="cfg-board-page" class="form-input medium" value="index.html">
          </div>
          <div class="form-group">
            <label class="form-label" for="cfg-sync-interval">Default Sync Interval</label>
            <div class="form-hint">How often boards auto-refresh (ms)</div>
            <select id="cfg-sync-interval" class="form-select" style="max-width:180px;">
              <option value="15000">15 seconds</option>
              <option value="30000" selected>30 seconds</option>
              <option value="60000">1 minute</option>
              <option value="120000">2 minutes</option>
              <option value="300000">5 minutes</option>
            </select>
          </div>
        </div>

        <div class="form-checkbox-row">
          <input type="checkbox" id="cfg-show-codewords" checked>
          <label class="form-checkbox-label" for="cfg-show-codewords">Enable codeword display on boards</label>
        </div>
        <div class="form-checkbox-row">
          <input type="checkbox" id="cfg-show-points" checked>
          <label class="form-checkbox-label" for="cfg-show-points">Show points on tiles</label>
        </div>
        <div class="form-checkbox-row">
          <input type="checkbox" id="cfg-allow-themes" checked>
          <label class="form-checkbox-label" for="cfg-allow-themes">Allow players to change themes</label>
        </div>

        <div class="form-actions">
          <button class="btn btn-primary" id="save-event-btn">Save Event Settings</button>
          <button class="btn btn-secondary" id="reset-event-btn">Reset to Defaults</button>
        </div>
      </div>
    </div>
        <!-- ===== TEAM MANAGEMENT ===== -->
    <div class="settings-card">
      <div class="card-header" tabindex="0" data-section="teams" role="button" aria-expanded="false">
        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        <span class="card-title">Team Management</span>
        <span class="team-count-badge" id="team-count-badge">0 Teams</span>
        <span class="card-toggle">▼</span>
      </div>
      <div class="card-body" id="section-teams">
        <div class="form-hint" style="margin-bottom:14px;">
          Configure up to 8 teams. Each team needs a unique key, display name, and a published Google Sheets CSV URL.
          Click a team row to expand its settings.
        </div>
        <div class="team-list" id="team-list"></div>
        <div class="form-actions" style="margin-top:16px;">
          <button class="btn btn-secondary" id="add-team-btn">+ Add New Team</button>
          <button class="btn btn-primary" id="save-teams-btn">Save All Teams</button>
        </div>
      </div>
    </div>

    <!-- ===== SHEET VARIABLES ===== -->
    <div class="settings-card">
      <div class="card-header" tabindex="0" data-section="variables" role="button" aria-expanded="false">
        <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zM6 20V4h5v7h7v9H6z"/></svg>
        <span class="card-title">Sheet Column Variables</span>
        <span class="card-badge">Reference</span>
        <span class="card-toggle">▼</span>
      </div>
      <div class="card-body" id="section-variables">
        <div class="form-hint" style="margin-bottom:14px;">
          These are the expected CSV columns from each team's Google Sheet. Ensure your sheet headers match this structure.
        </div>
        <table class="var-table">
          <thead>
            <tr>
              <th>Column</th>
              <th>Variable</th>
              <th>Type</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody id="var-table-body"></tbody>
        </table>

        <div style="margin-top:16px;">
          <div class="form-label" style="margin-bottom:6px;">Custom Variables</div>
          <div class="form-hint">Add extra columns to your sheet. They'll be accessible as metadata on each tile.</div>
          <div id="custom-var-list"></div>
          <div class="form-actions" style="margin-top:10px;">
            <button class="btn btn-secondary btn-sm" id="add-custom-var-btn">+ Add Custom Variable</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== IMPORT / EXPORT ===== -->
    <div class="settings-card">
      <div class="card-header" tabindex="0" data-section="io" role="button" aria-expanded="false">
        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        <span class="card-title">Import / Export Configuration</span>
        <span class="card-toggle">▼</span>
      </div>
      <div class="card-body" id="section-io">
        <div class="form-hint" style="margin-bottom:14px;">
          Export your entire game configuration as JSON to back it up, or import a previously saved config.
        </div>
        <div class="form-actions" style="margin-bottom:10px;">
          <button class="btn btn-success" id="export-config-btn">Export Configuration</button>
          <button class="btn btn-secondary" id="import-config-btn">Import Configuration</button>
          <button class="btn btn-danger" id="reset-all-btn">Reset Everything</button>
        </div>
        <textarea class="io-area" id="io-area" placeholder="Configuration JSON will appear here..." style="display:none;"></textarea>
      </div>
    </div>

    <!-- ===== DANGER ZONE ===== -->
    <div class="settings-card" style="border-color: rgba(255,109,109,0.3);">
      <div class="card-header" tabindex="0" data-section="danger" role="button" aria-expanded="false">
        <svg viewBox="0 0 24 24" style="fill:var(--danger);"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
        <span class="card-title" style="color:var(--danger);">Danger Zone</span>
        <span class="card-toggle">▼</span>
      </div>
      <div class="card-body" id="section-danger">
        <div class="form-hint" style="margin-bottom:14px; color:var(--danger);">
          These actions are destructive and cannot be undone. Proceed with caution.
        </div>
        <div class="form-actions">
          <button class="btn btn-danger" id="clear-teams-btn">Delete All Teams</button>
          <button class="btn btn-danger" id="clear-all-data-btn">Wipe All Local Data</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Footer -->
  <footer class="page-footer">
    <span>Game Settings v1.0</span>
    <span>&middot;</span>
    <span>Bingo Board System</span>
  </footer>
    <script>
(() => {
  const STORAGE_KEYS = {
    eventConfig: 'bingo-event-config',
    teams: 'bingo-teams-config',
    customVars: 'bingo-custom-vars'
  };

  const MAX_TEAMS = 8;

  const DEFAULT_EVENT = {
    name: 'Bingo 2026',
    tileCount: 49,
    startDate: '',
    endDate: '',
    description: '',
    boardPage: 'index.html',
    syncInterval: 30000,
    showCodewords: true,
    showPoints: true,
    allowThemes: true
  };

  const DEFAULT_TEAMS = {
    Warriors: {
      name: "The Spreadsheet Warriors",
      url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRFOGe_j8BL0X5Cwvy3LNmsrWG82IAXlWpump0Sw6PKWLz-1gxbisdbPuTmJ_CmjLA_q-Q6y9jTfFwq/pub?gid=1593254680&single=true&output=csv",
      color: "#e94560",
      codeword: "BINGO_BLITZ",
      points: 1250
    }
  };

  const SHEET_COLUMNS = [
    { col: 'A', key: 'title',       type: 'string',  desc: 'Display name for the tile' },
    { col: 'B', key: 'image',       type: 'url',     desc: 'Image filename or URL for tile artwork' },
    { col: 'C', key: 'current',     type: 'number',  desc: 'Current progress value' },
    { col: 'D', key: 'goal',        type: 'number',  desc: 'Target goal value (tile completes when current ≥ goal)' },
    { col: 'E', key: 'items',       type: 'string',  desc: 'Comma-separated checklist items' },
    { col: 'F', key: 'description', type: 'string',  desc: 'Tile description shown in modal' },
    { col: 'G', key: 'points',      type: 'number',  desc: 'Point value for completing this tile' }
  ];

  let eventConfig = { ...DEFAULT_EVENT };
  let teamsConfig = {};
  let customVars = [];

  /* --- DOM --- */
  const $ = id => document.getElementById(id);
  const DOM = {
    // Event
    eventName:     $('cfg-event-name'),
    tileCount:     $('cfg-tile-count'),
    startDate:     $('cfg-start-date'),
    endDate:       $('cfg-end-date'),
    description:   $('cfg-description'),
    boardPage:     $('cfg-board-page'),
    syncInterval:  $('cfg-sync-interval'),
    showCodewords: $('cfg-show-codewords'),
    showPoints:    $('cfg-show-points'),
    allowThemes:   $('cfg-allow-themes'),
    saveEventBtn:  $('save-event-btn'),
    resetEventBtn: $('reset-event-btn'),
    // Teams
    teamList:       $('team-list'),
    teamCountBadge: $('team-count-badge'),
    addTeamBtn:     $('add-team-btn'),
    saveTeamsBtn:   $('save-teams-btn'),
    // Variables
    varTableBody:   $('var-table-body'),
    customVarList:  $('custom-var-list'),
    addCustomVar:   $('add-custom-var-btn'),
    // I/O
    exportBtn:  $('export-config-btn'),
    importBtn:  $('import-config-btn'),
    resetAllBtn: $('reset-all-btn'),
    ioArea:     $('io-area'),
    // Danger
    clearTeamsBtn: $('clear-teams-btn'),
    clearAllBtn:   $('clear-all-data-btn'),
    // Toast
    toast: $('toast')
  };

  /* --- Helpers --- */
  const escapeHTML = (str) => {
    const d = document.createElement('div');
    d.appendChild(document.createTextNode(String(str ?? '')));
    return d.innerHTML;
  };

  const save = (key, val) => {
    try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
  };
  const load = (key) => {
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; } catch { return null; }
  };

  let toastTimer = null;
  const toast = (msg, type = 'success', duration = 2500) => {
    DOM.toast.textContent = msg;
    DOM.toast.className = 'toast show' + (type !== 'success' ? ' ' + type : '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => DOM.toast.classList.remove('show'), duration);
  };
    /* ========================= COLLAPSIBLE CARDS ========================= */
  function initCards() {
    document.querySelectorAll('.card-header').forEach(header => {
      header.addEventListener('click', () => toggleCard(header));
      header.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCard(header); }
      });
    });
  }

  function toggleCard(header) {
    const sectionId = 'section-' + header.dataset.section;
    const body = $(sectionId);
    const toggle = header.querySelector('.card-toggle');
    if (!body) return;
    const isOpen = body.classList.contains('open');
    body.classList.toggle('open');
    toggle.classList.toggle('open');
    header.setAttribute('aria-expanded', String(!isOpen));
  }

  /* ========================= EVENT CONFIG ========================= */
  function loadEventConfig() {
    const saved = load(STORAGE_KEYS.eventConfig);
    if (saved) eventConfig = { ...DEFAULT_EVENT, ...saved };
    populateEventForm();
  }

  function populateEventForm() {
    DOM.eventName.value = eventConfig.name;
    DOM.tileCount.value = eventConfig.tileCount;
    DOM.startDate.value = eventConfig.startDate || '';
    DOM.endDate.value = eventConfig.endDate || '';
    DOM.description.value = eventConfig.description || '';
    DOM.boardPage.value = eventConfig.boardPage || 'index.html';
    DOM.syncInterval.value = String(eventConfig.syncInterval || 30000);
    DOM.showCodewords.checked = eventConfig.showCodewords !== false;
    DOM.showPoints.checked = eventConfig.showPoints !== false;
    DOM.allowThemes.checked = eventConfig.allowThemes !== false;
  }

  function saveEventConfig() {
    const name = DOM.eventName.value.trim();
    if (!name) {
      DOM.eventName.classList.add('invalid');
      toast('Event name is required', 'error');
      DOM.eventName.focus();
      return;
    }
    DOM.eventName.classList.remove('invalid');

    eventConfig = {
      name: name,
      tileCount: Math.min(49, Math.max(1, parseInt(DOM.tileCount.value, 10) || 49)),
      startDate: DOM.startDate.value,
      endDate: DOM.endDate.value,
      description: DOM.description.value.trim(),
      boardPage: DOM.boardPage.value.trim() || 'index.html',
      syncInterval: parseInt(DOM.syncInterval.value, 10) || 30000,
      showCodewords: DOM.showCodewords.checked,
      showPoints: DOM.showPoints.checked,
      allowThemes: DOM.allowThemes.checked
    };

    save(STORAGE_KEYS.eventConfig, eventConfig);
    toast('Event settings saved!');
  }

  /* ========================= TEAM MANAGEMENT ========================= */
  function loadTeams() {
    const saved = load(STORAGE_KEYS.teams);
    teamsConfig = saved || { ...DEFAULT_TEAMS };
    renderTeamList();
  }

  function renderTeamList() {
    const keys = Object.keys(teamsConfig);
    DOM.teamCountBadge.textContent = `${keys.length} Team${keys.length !== 1 ? 's' : ''}`;
    DOM.teamList.innerHTML = '';

    if (keys.length === 0) {
      DOM.teamList.innerHTML = '<div style="color:var(--text-dim); font-size:0.85rem; padding:8px 0;">No teams configured. Click "+ Add New Team" to get started.</div>';
      return;
    }

    const frag = document.createDocumentFragment();
    keys.forEach(key => {
      const team = teamsConfig[key];
      const item = document.createElement('div');
      item.className = 'team-item';
      item.dataset.key = key;

      item.innerHTML = `
        <div class="team-item-header" tabindex="0" role="button" aria-expanded="false">
          <div class="team-item-name">
            <div class="team-dot" style="background:${escapeHTML(team.color || '#888')};"></div>
            <span>${escapeHTML(team.name || key)}</span>
          </div>
          <div class="team-item-meta">
            <span>${escapeHTML(key)}</span>
            <span>▼</span>
          </div>
        </div>
        <div class="team-item-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Team Key <span class="form-required">*</span></label>
              <div class="form-hint">Unique identifier (no spaces)</div>
              <input type="text" class="form-input medium team-key" value="${escapeHTML(key)}" maxlength="20" pattern="[A-Za-z0-9_]+">
            </div>
            <div class="form-group">
              <label class="form-label">Display Name <span class="form-required">*</span></label>
              <input type="text" class="form-input team-name" value="${escapeHTML(team.name || '')}" maxlength="40">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Google Sheet CSV URL <span class="form-required">*</span></label>
            <div class="form-hint">Published Google Sheets URL with &output=csv</div>
            <input type="url" class="form-input team-url" value="${escapeHTML(team.url || '')}" placeholder="https://docs.google.com/spreadsheets/d/e/...">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Team Color</label>
              <div class="form-inline">
                <input type="color" class="color-swatch team-color-picker" value="${team.color || '#e94560'}">
                <input type="text" class="form-input short team-color-hex" value="${escapeHTML(team.color || '#e94560')}" maxlength="7">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Points</label>
              <div class="form-hint">Starting/total points for this team</div>
              <input type="number" class="form-input short team-points" value="${parseInt(team.points, 10) || 0}" min="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Codeword</label>
            <div class="form-hint">Secret word shown on this team's board</div>
            <input type="text" class="form-input medium team-codeword" value="${escapeHTML(team.codeword || '')}" maxlength="30">
          </div>
          <div class="team-item-actions">
            <button class="btn btn-secondary btn-sm test-team-btn">Test Connection</button>
            <button class="btn btn-danger btn-sm delete-team-btn">Delete Team</button>
          </div>
        </div>
      `;

      // Toggle expand
      const header = item.querySelector('.team-item-header');
      const body = item.querySelector('.team-item-body');
      header.addEventListener('click', () => {
        const open = body.classList.contains('open');
        body.classList.toggle('open');
        header.setAttribute('aria-expanded', String(!open));
      });
      header.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          body.classList.toggle('open');
        }
      });

      // Color sync
      const picker = item.querySelector('.team-color-picker');
      const hex = item.querySelector('.team-color-hex');
      picker.addEventListener('input', () => { hex.value = picker.value; });
      hex.addEventListener('input', () => {
        if (/^#[0-9a-f]{6}$/i.test(hex.value)) picker.value = hex.value;
      });

      // Test connection
      item.querySelector('.test-team-btn').addEventListener('click', async () => {
        const url = item.querySelector('.team-url').value.trim();
        if (!url) { toast('Enter a URL first', 'error'); return; }
        try {
          const res = await fetch(`${url}&t=${Date.now()}`, {
            headers: { 'pragma': 'no-cache', 'cache-control': 'no-cache' }
          });
          const text = await res.text();
          const lines = text.split('\n').filter(l => l.trim());
          toast(`Connection OK! ${lines.length - 1} data rows found.`);
        } catch (e) {
          toast(`Connection failed: ${e.message}`, 'error');
        }
      });

      // Delete
      item.querySelector('.delete-team-btn').addEventListener('click', () => {
        if (confirm(`Delete team "${team.name || key}"? This won't be saved until you click Save.`)) {
          item.remove();
          updateTeamCountFromDOM();
        }
      });

      frag.appendChild(item);
    });

    DOM.teamList.appendChild(frag);
  }

  function updateTeamCountFromDOM() {
    const count = DOM.teamList.querySelectorAll('.team-item').length;
    DOM.teamCountBadge.textContent = `${count} Team${count !== 1 ? 's' : ''}`;
  }

  function collectTeamsFromDOM() {
    const newTeams = {};
    const items = DOM.teamList.querySelectorAll('.team-item');
    const errors = [];

    items.forEach((item, idx) => {
      const key = item.querySelector('.team-key').value.trim().replace(/\s+/g, '_');
      const name = item.querySelector('.team-name').value.trim();
      const url = item.querySelector('.team-url').value.trim();
      const color = item.querySelector('.team-color-hex').value.trim() || '#888888';
      const points = parseInt(item.querySelector('.team-points').value, 10) || 0;
      const codeword = item.querySelector('.team-codeword').value.trim();

      if (!key) errors.push(`Team ${idx + 1}: Key is required`);
      if (!name) errors.push(`Team ${idx + 1}: Name is required`);
      if (!url) errors.push(`Team ${idx + 1}: URL is required`);
      if (newTeams[key]) errors.push(`Duplicate team key: "${key}"`);

      if (key) {
        newTeams[key] = { name, url, color, points, codeword };
      }
    });

    return { teams: newTeams, errors };
  }

  function saveTeams() {
    const { teams, errors } = collectTeamsFromDOM();
    if (errors.length > 0) {
      toast(errors[0], 'error');
      return;
    }
    teamsConfig = teams;
    save(STORAGE_KEYS.teams, teamsConfig);
    renderTeamList();
    toast(`${Object.keys(teams).length} team(s) saved!`);
  }

  function addNewTeam() {
    const count = DOM.teamList.querySelectorAll('.team-item').length;
    if (count >= MAX_TEAMS) {
      toast(`Maximum ${MAX_TEAMS} teams allowed`, 'warning');
      return;
    }
    const newKey = `Team${count + 1}`;
    teamsConfig[newKey] = {
      name: `New Team ${count + 1}`,
      url: '',
      color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0'),
      points: 0,
      codeword: ''
    };
    renderTeamList();
    // Auto-open the new team
    const items = DOM.teamList.querySelectorAll('.team-item');
    const last = items[items.length - 1];
    if (last) {
      last.querySelector('.team-item-body').classList.add('open');
      last.querySelector('.team-key').focus();
    }
    toast('New team added — fill in the details and save');
  }
    /* ========================= SHEET VARIABLES TABLE ========================= */
  function renderVarTable() {
    DOM.varTableBody.innerHTML = '';
    const frag = document.createDocumentFragment();

    SHEET_COLUMNS.forEach(col => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="font-weight:bold; color:var(--text-bright);">${col.col}</td>
        <td><span class="var-key">${escapeHTML(col.key)}</span></td>
        <td><span class="var-type ${col.type}">${col.type}</span></td>
        <td class="var-desc">${escapeHTML(col.desc)}</td>
      `;
      frag.appendChild(tr);
    });

    // Custom vars
    customVars.forEach((cv, idx) => {
      const colLetter = String.fromCharCode(72 + idx); // H, I, J...
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="font-weight:bold; color:var(--text-bright);">${colLetter}</td>
        <td><span class="var-key">${escapeHTML(cv.key)}</span></td>
        <td><span class="var-type ${cv.type || 'string'}">${cv.type || 'string'}</span></td>
        <td class="var-desc">${escapeHTML(cv.desc || 'Custom variable')}</td>
      `;
      frag.appendChild(tr);
    });

    DOM.varTableBody.appendChild(frag);
  }

  function loadCustomVars() {
    customVars = load(STORAGE_KEYS.customVars) || [];
    renderVarTable();
    renderCustomVarEditor();
  }

  function renderCustomVarEditor() {
    DOM.customVarList.innerHTML = '';
    if (customVars.length === 0) {
      DOM.customVarList.innerHTML = '<div style="font-size:0.75rem; color:var(--text-dim); padding:4px 0;">No custom variables defined.</div>';
      return;
    }

    const frag = document.createDocumentFragment();
    customVars.forEach((cv, idx) => {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex; gap:8px; align-items:center; margin-bottom:6px;';
      row.innerHTML = `
        <input type="text" class="form-input" style="max-width:120px;" value="${escapeHTML(cv.key)}" placeholder="key" data-cv-idx="${idx}" data-cv-field="key">
        <select class="form-select" style="max-width:100px;" data-cv-idx="${idx}" data-cv-field="type">
          <option value="string" ${cv.type === 'string' ? 'selected' : ''}>String</option>
          <option value="number" ${cv.type === 'number' ? 'selected' : ''}>Number</option>
          <option value="boolean" ${cv.type === 'boolean' ? 'selected' : ''}>Boolean</option>
          <option value="url" ${cv.type === 'url' ? 'selected' : ''}>URL</option>
        </select>
        <input type="text" class="form-input" style="flex:1;" value="${escapeHTML(cv.desc || '')}" placeholder="Description" data-cv-idx="${idx}" data-cv-field="desc">
        <button class="btn btn-danger btn-sm remove-cv-btn" data-cv-idx="${idx}" style="padding:4px 8px;">✕</button>
      `;
      frag.appendChild(row);
    });
    DOM.customVarList.appendChild(frag);

    // Wire remove buttons
    DOM.customVarList.querySelectorAll('.remove-cv-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.dataset.cvIdx, 10);
        customVars.splice(idx, 1);
        save(STORAGE_KEYS.customVars, customVars);
        renderVarTable();
        renderCustomVarEditor();
        toast('Custom variable removed');
      });
    });

    // Wire field changes
    DOM.customVarList.querySelectorAll('[data-cv-field]').forEach(el => {
      el.addEventListener('change', () => {
        const idx = parseInt(el.dataset.cvIdx, 10);
        const field = el.dataset.cvField;
        customVars[idx][field] = el.value.trim();
        save(STORAGE_KEYS.customVars, customVars);
        renderVarTable();
      });
    });
  }

  function addCustomVar() {
    if (customVars.length >= 10) {
      toast('Maximum 10 custom variables', 'warning');
      return;
    }
    customVars.push({ key: `custom_${customVars.length + 1}`, type: 'string', desc: '' });
    save(STORAGE_KEYS.customVars, customVars);
    renderVarTable();
    renderCustomVarEditor();
    toast('Custom variable added');
  }

  /* ========================= IMPORT / EXPORT ========================= */
  function exportConfig() {
    const data = {
      version: '1.0',
      exportedAt: new Date().toISOString(),
      event: eventConfig,
      teams: teamsConfig,
      customVars: customVars
    };
    DOM.ioArea.value = JSON.stringify(data, null, 2);
    DOM.ioArea.style.display = 'block';
    DOM.ioArea.focus();
    DOM.ioArea.select();
    toast('Configuration exported — copy the JSON below');
  }

  function importConfig() {
    if (DOM.ioArea.style.display === 'none') {
      DOM.ioArea.style.display = 'block';
      DOM.ioArea.value = '';
      DOM.ioArea.placeholder = 'Paste your configuration JSON here, then click Import again...';
      DOM.ioArea.focus();
      toast('Paste JSON then click Import again', 'warning');
      return;
    }

    const raw = DOM.ioArea.value.trim();
    if (!raw) { toast('Paste configuration JSON first', 'error'); return; }

    try {
      const data = JSON.parse(raw);

      if (data.event && typeof data.event === 'object') {
        eventConfig = { ...DEFAULT_EVENT, ...data.event };
        save(STORAGE_KEYS.eventConfig, eventConfig);
        populateEventForm();
      }

      if (data.teams && typeof data.teams === 'object') {
        teamsConfig = data.teams;
        save(STORAGE_KEYS.teams, teamsConfig);
        renderTeamList();
      }

      if (Array.isArray(data.customVars)) {
        customVars = data.customVars.slice(0, 10);
        save(STORAGE_KEYS.customVars, customVars);
        renderVarTable();
        renderCustomVarEditor();
      }

      DOM.ioArea.style.display = 'none';
      toast('Configuration imported successfully!');
    } catch (e) {
      toast('Invalid JSON format: ' + e.message, 'error');
    }
  }

  /* ========================= DANGER ZONE ========================= */
  function clearAllTeams() {
    if (!confirm('Delete ALL teams? This will save immediately.')) return;
    teamsConfig = {};
    save(STORAGE_KEYS.teams, teamsConfig);
    renderTeamList();
    toast('All teams deleted', 'warning');
  }

  function clearAllData() {
    if (!confirm('This will wipe ALL game settings, teams, and custom variables from local storage. Are you absolutely sure?')) return;
    if (!confirm('Final confirmation — this CANNOT be undone. Proceed?')) return;

    localStorage.removeItem(STORAGE_KEYS.eventConfig);
    localStorage.removeItem(STORAGE_KEYS.teams);
    localStorage.removeItem(STORAGE_KEYS.customVars);

    eventConfig = { ...DEFAULT_EVENT };
    teamsConfig = {};
    customVars = [];

    populateEventForm();
    renderTeamList();
    renderVarTable();
    renderCustomVarEditor();

    toast('All data wiped', 'warning');
  }

  function resetEventDefaults() {
    if (!confirm('Reset event settings to defaults?')) return;
    eventConfig = { ...DEFAULT_EVENT };
    save(STORAGE_KEYS.eventConfig, eventConfig);
    populateEventForm();
    toast('Event settings reset to defaults');
  }

  /* ========================= INIT ========================= */
  function init() {
    initCards();
    loadEventConfig();
    loadTeams();
    loadCustomVars();

    // Event settings
    DOM.saveEventBtn.addEventListener('click', saveEventConfig);
    DOM.resetEventBtn.addEventListener('click', resetEventDefaults);

    // Teams
    DOM.addTeamBtn.addEventListener('click', addNewTeam);
    DOM.saveTeamsBtn.addEventListener('click', saveTeams);

    // Custom vars
    DOM.addCustomVar.addEventListener('click', addCustomVar);

    // Import/Export
    DOM.exportBtn.addEventListener('click', exportConfig);
    DOM.importBtn.addEventListener('click', importConfig);
    DOM.resetAllBtn.addEventListener('click', () => {
      if (confirm('Reset entire configuration to factory defaults?')) {
        clearAllData();
      }
    });

    // Danger zone
    DOM.clearTeamsBtn.addEventListener('click', clearAllTeams);
    DOM.clearAllBtn.addEventListener('click', clearAllData);

    // Warn before leaving with unsaved changes
    let formDirty = false;
    document.querySelectorAll('.form-input, .form-select, .form-textarea, input[type="checkbox"], input[type="color"]').forEach(el => {
      el.addEventListener('change', () => { formDirty = true; });
      el.addEventListener('input', () => { formDirty = true; });
    });

    window.addEventListener('beforeunload', (e) => {
      if (formDirty) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Clear dirty flag on save
    const clearDirty = () => { formDirty = false; };
    DOM.saveEventBtn.addEventListener('click', clearDirty);
    DOM.saveTeamsBtn.addEventListener('click', clearDirty);
  }

  init();
})();
  </script>
</body>
</html>
