<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gains - Bingo Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cabin+Condensed:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-body: #342e25; --bg-tile: #494034; --bg-well: #342e25;
      --bg-completed: #1e3a1e; --bg-completed-well: #162a16;
      --border-main: #6d604e; --border-completed: #4caf50;
      --accent: #ffac00; --text-main: #ffac00; --text-bright: #ffee00;
      --text-dim: #858476; --text-completed: #4caf50; --danger: #ff6d6d;
    }
    * { box-sizing: border-box; }
    html { scrollbar-gutter: stable; overflow-y: scroll; }
    ::-webkit-scrollbar { width: 12px; height: 12px; }
    ::-webkit-scrollbar-track { background: var(--bg-well); }
    ::-webkit-scrollbar-thumb { background: var(--bg-tile); border: 2px solid var(--bg-well); }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-main); }
    ::-webkit-scrollbar-corner { background: var(--bg-well); }
    body {
      background-color: var(--bg-body); color: var(--text-main);
      font-family: 'Cabin Condensed', sans-serif; margin: 0; padding: 20px;
      min-height: 100vh;
    }
    .sr-only {
      position: absolute !important;
      width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); border: 0; white-space: nowrap;
    }
    .gains-header {
      background: var(--bg-tile); border: 2px solid var(--border-main);
      padding: 20px; margin: 0 auto 30px auto; max-width: 95%;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    .gains-header h1 {
      margin: 0; font-size: 2rem; text-transform: uppercase;
      letter-spacing: 1px; text-shadow: 2px 2px 4px black;
    }
    .nav-btn {
      background: var(--bg-well); border: 2px solid var(--border-main);
      color: var(--text-dim); padding: 8px 16px;
      font-family: 'Cabin Condensed'; font-size: 0.95rem;
      cursor: pointer; border-radius: 0;
      transition: all 0.2s ease; text-decoration: none; display: inline-block;
    }
    .nav-btn:hover {
      border-color: var(--accent); color: var(--accent); background: var(--bg-tile);
    }
    #admin-back-btn {
      border-color: var(--accent);
      color: var(--accent);
      font-weight: bold;
    }
    #admin-back-btn:hover {
      background: var(--accent);
      color: var(--bg-body);
    }
    .gains-container { max-width: 95%; margin: 0 auto; }
    .table-wrapper {
      background: var(--bg-tile); border: 2px solid var(--border-main);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      overflow: auto; max-height: 65vh;
    }
    table {
      width: 100%; border-collapse: collapse; font-size: 0.9rem;
    }
    th, td {
      padding: 8px 12px; border: 1px solid var(--border-main);
      text-align: center; white-space: nowrap;
    }
    thead {
      background-color: var(--bg-well);
    }
    th {
      font-weight: bold; color: var(--text-bright);
      text-transform: uppercase; letter-spacing: 0.5px;
      cursor: pointer; user-select: none;
      position: sticky; top: 0; z-index: 15;
      background-color: var(--bg-well);
    }
    th:hover { background-color: var(--bg-body); color: var(--accent); }
    th .sort-arrow {
      display: inline-block; width: 0; height: 0;
      border-left: 4px solid transparent; border-right: 4px solid transparent;
      margin-left: 6px; vertical-align: middle; opacity: 0.5;
    }
    th.asc .sort-arrow { border-bottom: 5px solid var(--accent); opacity: 1; }
    th.desc .sort-arrow { border-top: 5px solid var(--accent); opacity: 1; }
    tbody tr:nth-child(even) { background-color: var(--bg-well); }
    tbody tr:hover { background-color: var(--bg-body); }
    td { color: var(--text-bright); }
    td.player-name { font-weight: bold; color: var(--accent); }
    td.zero { color: var(--text-dim); }
    td.highest { color: var(--text-completed); font-weight: bold; }
    .page-footer {
      margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-main);
      font-size: 0.7rem; color: var(--border-main);
      display: flex; justify-content: center; align-items: center; gap: 6px;
    }
    .loader {
      text-align: center; padding: 40px; font-size: 1.2rem;
      color: var(--text-dim);
    }

    /* Sticky Player Column */
    th:first-child, td:first-child {
      position: sticky; left: 0; z-index: 10;
      text-align: left;
      border-right: 2px solid var(--border-main);
    }
    th:first-child { z-index: 20; background-color: var(--bg-well); }
    tbody tr td:first-child { background-color: var(--bg-body); }
    tbody tr:nth-child(even) td:first-child { background-color: var(--bg-well); }
    tbody tr:hover td:first-child { background-color: var(--bg-body); }

    .settings-btn {
      background: none; border: 2px solid var(--border-main);
      color: var(--text-dim); width: 38px; height: 38px;
      border-radius: 0; cursor: pointer;
      display: flex; justify-content: center; align-items: center;
      transition: all 0.2s ease; flex-shrink: 0;
      font-size: 1.3rem; padding: 0; text-decoration: none;
    }
    .settings-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--bg-well); }
    .settings-btn svg { width: 20px; height: 20px; fill: currentColor; }

    /* Modal & Settings CSS */
    #modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.75); display: none;
      justify-content: center; align-items: center; z-index: 2000;
      backdrop-filter: blur(3px);
    }
    #modal-overlay.active { display: flex; }
    .modal-content {
      background-color: var(--bg-tile); border: 3px solid var(--border-main);
      width: 95vw; max-width: 600px; padding: 25px;
      box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 30px 5px var(--accent);
      display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto;
    }
    .modal-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .modal-close-btn {
      background: none; border: none; padding: 4px; cursor: pointer;
      color: var(--text-dim); font-size: 2rem; line-height: 1;
    }
    .modal-close-btn:hover { color: var(--accent); }
    .modal-header {
      font-size: 1.8rem; margin: 0 0 15px 0; text-align: center;
      font-weight: bold; color: var(--text-main);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    .settings-section { margin-bottom: 18px; }
    .settings-section-title {
      font-size: 0.75rem; text-transform: uppercase; font-weight: bold;
      color: var(--text-dim); letter-spacing: 1px; margin-bottom: 8px;
      padding-bottom: 4px; border-bottom: 1px solid var(--border-main);
    }
    .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    .settings-row-label { font-size: 1rem; color: var(--text-bright); }
    .settings-row-hint { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; }
    .settings-select {
      background: var(--bg-well); color: var(--text-main);
      border: 1px solid var(--border-main); padding: 5px 10px;
      font-family: 'Cabin Condensed'; cursor: pointer;
      font-size: 1rem; border-radius: 0; min-width: 140px;
    }
    .settings-select:focus { border-color: var(--accent); outline: none; }
  </style>
</head>
<body>

  <header class="gains-header" role="banner">
    <h1><svg style="width:1em; height:1em; fill:currentColor; vertical-align: -0.15em; margin-right: 10px;" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5 9.2h3V19H5zM10.6 5h3v14h-3zm5.6 8h3v6h-3z"/></svg>Gains Tracker</h1>
    <div style="display:flex; gap:10px; align-items:center;">
      <a href="admin.html" id="admin-back-btn" class="nav-btn" style="display:none;">‚Üê Admin</a>
      <button class="settings-btn" id="settings-trigger" aria-label="Open settings">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.611 3.611 0 0112 15.6z"/></svg>
      </button>
    </div>
  </header>

  <div class="gains-container">
    <div class="table-wrapper" id="table-wrapper">
      <div class="loader" id="loader">Loading gains data...</div>
      <table id="gains-table" style="display:none;">
        <thead id="gains-table-head"></thead>
        <tbody id="gains-table-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="modal-overlay">
    <div class="modal-content">
      <div class="modal-top-bar">
        <div></div>
        <button class="modal-close-btn" id="modal-close" aria-label="Close settings">&times;</button>
      </div>
      <div class="modal-header">SETTINGS</div>

      <div class="settings-section">
        <div class="settings-section-title">Appearance</div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Theme</div>
            <div class="settings-row-hint">Choose a visual style</div>
          </div>
          <label for="settings-theme-dropdown" class="sr-only">Select Theme</label>
          <select id="settings-theme-dropdown" class="settings-select">
          </select>
        </div>
      </div>
    </div>
  </div>

  <footer class="page-footer">
    <span>v3.342</span>
    <span>&middot;</span>
    <span>Bingo Gains Tracker</span>
  </footer>

  <script src="js/themes.js"></script>
  <script>
  (() => {
    const APP_VERSION = '3.342';
    const SNAPSHOT_1_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFOGe_j8BL0X5Cwvy3LNmsrWG82IAXlWpump0Sw6PKWLz-1gxbisdbPuTmJ_CmjLA_q-Q6y9jTfFwq/pub?gid=138917819&single=true&output=csv';
    const SNAPSHOT_2_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFOGe_j8BL0X5Cwvy3LNmsrWG82IAXlWpump0Sw6PKWLz-1gxbisdbPuTmJ_CmjLA_q-Q6y9jTfFwq/pub?gid=2084936163&single=true&output=csv';

    const HEADERS = [
      'Player','Total','Attack','Defence','Strength','Hitpoints','Ranged','Prayer','Magic','Cooking','Woodcutting','Fletching','Fishing','Firemaking','Crafting','Smithing','Mining','Herblore','Agility','Thieving','Slayer','Farming','Runecraft','Hunter','Construction','Sailing','Abyssal Sire','Alchemical Hydra','Amoxilatl','Araxxor','Artio','Barrows Chests','Bryophyta','Brutus','Callisto','Calvar\'ion','Cerberus','Chambers of Xeric','Chambers of Xeric: CM','Chaos Elemental','Chaos Fanatic','Commander Zilyana','Corporeal Beast','Crazy Archaeologist','Dagannoth Prime','Dagannoth Rex','Dagannoth Supreme','Deranged Archaeologist','Doom of Mokhaiotl','Duke Sucellus','General Graardor','Giant Mole','Grotesque Guardians','Hespori','Kalphite Queen','King Black Dragon','Kraken','Kree\'Arra','K\'ril Tsutsaroth','Lunar Chests','Mimic','Nex','Nightmare','Phosani\'s Nightmare','Obor','Phantom Muspah','Sarachnis','Scorpia','Scurrius','Shellbane Griffin','Skotizo','Sol Heredit','Spindel','Tempoross','The Gauntlet','The Corrupted Gauntlet','The Hueycoatl','The Leviathan','The Royal Titans','The Whisperer','Theatre of Blood','Theatre of Blood: HM','Thermonuclear Smoke Devil','Tombs of Amascut: Normal','Tombs of Amascut: Expert','TzKal-Zuk','TzTok-Jad','Vardorvis','Venenatis','Vet\'ion','Vorkath','Wintertodt','Yama','Zalcano','Zulrah'
    ];
    
    const SKILL_HEADERS = HEADERS.slice(2, 26);
    const BOSS_HEADERS = HEADERS.slice(26);

    let gainsData = [];
    let sortState = { column: 'Total', order: 'desc' };

    const STORAGE_KEYS = {
      theme: 'bingo-theme'
    };

    const $ = id => document.getElementById(id);
    const escapeHTML = (str) => {
      const d = document.createElement('div');
      d.appendChild(document.createTextNode(String(str ?? '')));
      return d.innerHTML;
    };

    const storageLoad = (k, fb) => {
      try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fb; } catch { return fb; }
    };
    const storageSave = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

    const THEME_VARS = window.BINGO_THEME_VARS;
    const THEMES = window.BINGO_THEMES;

    const DOM = {
      themeSel: $('settings-theme-dropdown'),
      modalOverlay: $('modal-overlay'),
      modalClose: $('modal-close'),
      settingsTrigger: $('settings-trigger')
    };

    const applyTheme = (name) => {
      const root = document.documentElement;
      for (const k of THEME_VARS) root.style.setProperty(k, '');
      const t = THEMES[name];
      if (t) for (const [k, v] of Object.entries(t)) root.style.setProperty(k, v);
      storageSave(STORAGE_KEYS.theme, name);
      if (DOM.themeSel) DOM.themeSel.value = name;
    };

    const updateThemeDropdownVisuals = () => {
      if (!DOM.themeSel) return;
      const defaultStyle = { '--bg-tile': '#494034', '--text-main': '#ffac00' };
      Array.from(DOM.themeSel.options).forEach(opt => {
        const t = THEMES[opt.value] || defaultStyle;
        if (t) {
          opt.style.backgroundColor = t['--bg-tile'] || t['--bg-body'];
          opt.style.color = t['--text-main'];
        }
      });
    };

    const openSettings = () => {
      DOM.modalOverlay.classList.add('active');
    };
    const closeSettings = () => {
      DOM.modalOverlay.classList.remove('active');
    };

    const parseCSV = (text) => {
      const data = {};
      const rows = text.replace(/\r/g, '').split('\n').slice(1); // Skip header
      for (const row of rows) {
        if (!row.trim()) continue;
        const cols = row.split(',');
        const playerName = cols[0].trim();
        if (!playerName) continue;
        
        data[playerName] = {};
        for (let i = 1; i < HEADERS.length; i++) {
          const header = HEADERS[i];
          const value = cols[i] ? cols[i].trim() : '0';
          data[playerName][header] = (value === 'Not Found' || value === '-1') ? 0 : parseInt(value, 10) || 0;
        }
      }
      return data;
    };

    const fetchAndParseCSV = async (url) => {
      const res = await fetch(url + '&t=' + Date.now());
      if (!res.ok) throw new Error(`Failed to fetch ${url}`);
      const text = await res.text();
      return parseCSV(text);
    };

    const calculateGains = (snap1, snap2) => {
      const gains = [];
      for (const player in snap2) {
        if (snap1[player]) {
          const playerGains = { Player: player };
          let totalBossKc = 0;
          for (const header of HEADERS.slice(1)) {
            const gain = (snap2[player][header] || 0) - (snap1[player][header] || 0);
            playerGains[header] = gain;
            if (BOSS_HEADERS.includes(header)) {
              totalBossKc += gain;
            }
          }
          playerGains['Total Boss KC'] = totalBossKc;
          gains.push(playerGains);
        }
      }
      return gains;
    };

    const renderTable = () => {
      const tableHead = $('gains-table-head');
      const tableBody = $('gains-table-body');
      
      // Sort data
      gainsData.sort((a, b) => {
        const valA = a[sortState.column];
        const valB = b[sortState.column];
        const order = sortState.order === 'asc' ? 1 : -1;
        if (typeof valA === 'string') {
          return valA.localeCompare(valB) * order;
        }
        return (valA - valB) * order;
      });

      // Calculate Max Values for highlighting
      const maxVals = {};
      const numericHeaders = ['Total', 'Total Boss KC', ...SKILL_HEADERS, ...BOSS_HEADERS];
      numericHeaders.forEach(h => {
        maxVals[h] = 0;
        gainsData.forEach(row => {
          const val = row[h];
          if (typeof val === 'number' && val > maxVals[h]) maxVals[h] = val;
        });
      });

      // Render Header
      if (!tableHead.innerHTML) {
        const displayHeaders = ['Player', 'Total', 'Total Boss KC', ...SKILL_HEADERS, ...BOSS_HEADERS];
        let headHTML = '<tr>';
        for (const header of displayHeaders) {
          const isSortCol = sortState.column === header;
          const sortClass = isSortCol ? sortState.order : '';
          headHTML += `<th data-col="${header}" class="${sortClass}">${header}<span class="sort-arrow"></span></th>`;
        }
        headHTML += '</tr>';
        tableHead.innerHTML = headHTML;
      }

      // Render Body
      let bodyHTML = '';
      for (const player of gainsData) {
        bodyHTML += '<tr>';
        const displayHeaders = ['Player', 'Total', 'Total Boss KC', ...SKILL_HEADERS, ...BOSS_HEADERS];
        for (const header of displayHeaders) {
          const value = player[header];
          if (header === 'Player') {
            bodyHTML += `<td class="player-name">${value}</td>`;
          } else {
            const display = value === 0 ? '' : '+' + value.toLocaleString();
            const isHighest = value > 0 && value === maxVals[header];
            const classes = (value === 0 ? 'zero ' : '') + (isHighest ? 'highest' : '');
            bodyHTML += `<td class="${classes}">${display}</td>`;
          }
        }
        bodyHTML += '</tr>';
      }
      tableBody.innerHTML = bodyHTML;
      
      // Update sort arrows
      tableHead.querySelectorAll('th').forEach(th => {
        const col = th.dataset.col;
        th.classList.remove('asc', 'desc');
        if (col === sortState.column) {
          th.classList.add(sortState.order);
        }
      });
    };
    
    const handleSort = (e) => {
      const col = e.target.dataset.col;
      if (!col) return;
      
      if (sortState.column === col) {
        sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.column = col;
        sortState.order = 'desc';
      }
      renderTable();
    };

    const init = async () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get('fromAdmin') === 'true') {
        const btn = $('admin-back-btn');
        if (btn) btn.style.display = 'inline-flex';
      }

      const themeSel = DOM.themeSel;
      if (themeSel) {
        // Populate standard themes
        if (window.BINGO_THEME_METADATA) {
          window.BINGO_THEME_METADATA.forEach(meta => {
            const opt = document.createElement('option');
            opt.value = meta.value;
            opt.textContent = meta.label;
            themeSel.appendChild(opt);
          });
        }

        // Visuals
        const defaultStyle = { '--bg-tile': '#494034', '--text-main': '#ffac00' };
        Array.from(themeSel.options).forEach(opt => {
          const t = THEMES[opt.value] || defaultStyle;
          if (t) {
            opt.style.backgroundColor = t['--bg-tile'] || t['--bg-body'];
            opt.style.color = t['--text-main'];
          }
        });

        themeSel.addEventListener('change', () => {
          applyTheme(themeSel.value);
        });
      }

      const savedTheme = storageLoad(STORAGE_KEYS.theme, 'osrs');
      applyTheme(savedTheme);

      DOM.settingsTrigger.addEventListener('click', openSettings);
      DOM.modalClose.addEventListener('click', closeSettings);

      try {
        const [snap1, snap2] = await Promise.all([
          fetchAndParseCSV(SNAPSHOT_1_URL),
          fetchAndParseCSV(SNAPSHOT_2_URL)
        ]);
        
        gainsData = calculateGains(snap1, snap2);
        
        $('loader').style.display = 'none';
        $('gains-table').style.display = '';
        
        renderTable();
        
        $('gains-table-head').addEventListener('click', handleSort);

      } catch (error) {
        console.error("Failed to load gains data:", error);
        $('loader').innerText = `Error loading data: ${error.message}. Please check the console.`;
      }
    };

    init();
  })();
  </script>
</body>
</html>