<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bingo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cabin+Condensed:wght@400;700&display=swap" rel="stylesheet">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https: http: data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src https:; script-src 'self' 'unsafe-inline';">

  <style>
    :root {
      --bg-body: #342e25;
      --bg-tile: #494034;
      --bg-well: #342e25;
      --bg-completed: #1e3a1e;
      --bg-completed-well: #162a16;
      --border-main: #6d604e;
      --border-completed: #4caf50;
      --accent: #ffac00;
      --text-main: #ffac00;
      --text-bright: #ffee00;
      --text-dim: #858476;
      --text-completed: #4caf50;
      --danger: #ff6d6d;
    }

    * { box-sizing: border-box; }
    html { scrollbar-gutter: stable; overflow-y: scroll; }

    .sr-only {
      position: absolute !important;
      width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); border: 0; white-space: nowrap;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-well); }
    ::-webkit-scrollbar-thumb { background: var(--bg-tile); border: 2px solid var(--bg-well); }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-main); }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: 'Cabin Condensed', sans-serif;
      margin: 0; padding: 15px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }

    .dashboard {
      width: 100%; max-width: 1580px;
      background: var(--bg-tile); border: 2px solid var(--border-main);
      padding: 10px 20px; margin-bottom: 20px;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 100;
    }
    .dashboard-main { display: flex; flex-direction: column; flex: 1; min-width: 0; }
    #event-title {
      font-size: 1.6rem; margin: 0; text-transform: uppercase;
      letter-spacing: 1px; text-shadow: 2px 2px 4px black;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    #team-name {
      font-size: 1.1rem; color: #ffffff; margin: 2px 0 0 0;
      text-shadow: 1px 1px 2px black; font-weight: bold;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .stats-container { display: flex; gap: 15px; align-items: center; flex-shrink: 0; flex-wrap: wrap; }
    .stat-item { text-align: center; }
    .stat-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-dim); display: block; }
    .stat-value { font-size: 1.3rem; font-weight: bold; color: var(--text-main); }
    #codeword-display {
      cursor: pointer; background: var(--bg-well);
      padding: 2px 10px; border-radius: 4px;
      min-width: 90px; text-align: center; display: inline-block;
    }
    .codeword-hidden { color: var(--bg-well); text-shadow: none; }

    .settings-btn {
      background: none; border: 2px solid var(--border-main);
      color: var(--text-dim); width: 38px; height: 38px;
      border-radius: 4px; cursor: pointer;
      display: flex; justify-content: center; align-items: center;
      transition: all 0.2s ease; flex-shrink: 0;
      font-size: 1.3rem; padding: 0; order: 10;
    }
    .settings-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--bg-well); }
    .settings-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .settings-btn svg { width: 20px; height: 20px; fill: currentColor; }

    #admin-back-btn {
      width: auto; padding: 0 12px;
      background: var(--bg-well); border-color: var(--accent);
      color: var(--accent); font-weight: bold;
      font-family: 'Cabin Condensed', sans-serif;
      text-transform: uppercase; letter-spacing: 0.5px;
      font-size: 0.9rem; gap: 6px;
    }
    #admin-back-btn:hover { background: var(--accent); color: var(--bg-body); }

    .minimap-wrapper {
      background: var(--bg-well); padding: 4px;
      border: 2px solid var(--border-main); flex-shrink: 0;
      cursor: pointer; transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .minimap-wrapper:hover { transform: scale(1.05); border-color: var(--accent); }
    .minimap-wrapper:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .minimap-container {
      display: grid; grid-template-columns: repeat(var(--grid-cols, 7), 10px);
      grid-template-rows: repeat(var(--grid-rows, 7), 10px); gap: 2px; pointer-events: none;
    }
    .mini-tile {
      width: 10px; height: 10px; background: var(--bg-body);
      display: flex; justify-content: center; align-items: center;
      font-size: 7px; color: rgba(255,255,255,0.2); border-radius: 1px;
    }
    .mini-tile.complete { background: var(--bg-completed); color: var(--text-completed); }

    .grid-container {
      display: grid; grid-template-columns: repeat(var(--grid-cols, 7), 1fr);
      gap: 10px; width: 100%; max-width: 1580px;
    }

    .tile {
      background-color: var(--bg-tile); border: 2px solid var(--border-main);
      position: relative; aspect-ratio: 1 / 1;
      display: flex; flex-direction: column; padding: 5%;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5); overflow: hidden;
      container-type: inline-size; cursor: pointer;
      transition: all 0.3s ease, opacity 0.4s ease;
    }
    .tile.completed { background-color: var(--bg-completed); border-color: var(--border-completed); }
    .tile:hover {
      transform: scale(1.05); z-index: 50;
      box-shadow: 0 0 25px 2px var(--accent), inset 0 0 10px rgba(0,0,0,0.5);
    }
    .tile.completed:hover { box-shadow: 0 0 25px 2px var(--border-completed), inset 0 0 10px rgba(0,0,0,0.5); }
    .tile:focus-visible { outline: 3px solid var(--accent); outline-offset: 2px; transform: scale(1.02); z-index: 60; }
    .tile.completed:focus-visible { outline-color: var(--border-completed); }
    .tile.ghost { opacity: 0; pointer-events: none; }

    .header-box {
      padding: 2% 0; margin-bottom: 2%; min-height: 18%;
      display: flex; justify-content: center; align-items: center;
      flex-shrink: 0; overflow: hidden; text-align: center;
    }
    .header-content {
      width: 100%; font-weight: bold; font-size: 8cqw;
      line-height: 1; white-space: nowrap;
      text-shadow: 1px 1px 2px black; color: var(--text-main);
    }
    .tile.completed .header-content { color: var(--text-completed); }

    .img-container {
      height: 40%; display: flex; justify-content: center;
      align-items: center; margin-bottom: 2%; flex-shrink: 0;
    }
    .img-container img {
      max-height: 100%; max-width: 95%; object-fit: contain;
      filter: drop-shadow(2px 3px 4px black);
    }

    .progress-container {
      margin-bottom: 2%; height: 2cqw; min-height: 5px;
      width: 100%; flex-shrink: 0;
    }
    .tile.completed .progress-container { display: none; }
    .progress-bg { background: var(--bg-well); height: 100%; border: 1px solid #000; width: 100%; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.5s ease, background-color 0.5s ease; }

    .checklist-box {
      background: var(--bg-well); border: 1px solid #000;
      padding: 3%; flex-grow: 1; width: 100%;
      overflow-y: auto; min-height: 0;
      transition: background 0.3s ease; position: relative;
    }
    .tile.completed .checklist-box { background: var(--bg-completed-well); }
    .tile.completed .checklist-box::-webkit-scrollbar-track { background: var(--bg-completed); }
    .tile.completed .checklist-box::-webkit-scrollbar-thumb { background: var(--bg-completed-well); border: 2px solid var(--bg-completed); }

    .check-item { display: flex; align-items: center; margin-bottom: 4px; }
    .check-mark {
      width: 1.2em; height: 1.2em; margin-right: 6px; flex-shrink: 0;
      position: relative; display: flex; justify-content: center; align-items: center;
    }
    .check-mark::after {
      content: ''; width: 0.3em; height: 0.6em;
      border: solid var(--text-completed); border-width: 0 0.2em 0.2em 0;
      transform: rotate(45deg);
    }
    .tile .check-item { font-size: 6cqw; color: var(--text-bright); }
    .tile.completed .check-item { color: var(--text-completed); }

    .point-badge {
      position: absolute; bottom: 5px; right: 5px;
      background: var(--bg-well); border: 1px solid var(--accent);
      padding: 1px 5px; border-radius: 3px;
      font-size: 10px; font-weight: bold;
      color: var(--text-main); z-index: 10;
    }
    .tile.completed .point-badge {
      border-color: var(--border-completed); color: var(--text-completed);
      background: var(--bg-completed-well);
    }
    .tile.no-data { opacity: 0.55; cursor: default; }
    .tile.no-data:hover { transform: none; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); z-index: auto; }
    .tile.no-data:focus-visible { outline: none; transform: none; }

    #modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0); display: none;
      justify-content: center; align-items: center; z-index: 2000;
      backdrop-filter: blur(0px);
      transition: background 0.4s ease, backdrop-filter 0.4s ease;
    }
    #modal-overlay.active { background: rgba(0,0,0,0.75); backdrop-filter: blur(5px); }

    .modal-content {
      background-color: var(--bg-tile); border: 3px solid var(--border-main);
      width: 95vw; max-width: 650px; padding: 25px;
      position: fixed; box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 30px 5px var(--accent);
      display: flex; flex-direction: column;
      opacity: 0; transform: translate(-50%, -50%) scale(0);
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none; z-index: 2001;
      max-height: 90vh; overflow-y: auto;
    }
    .modal-content.completed {
      background-color: var(--bg-completed); border-color: var(--border-completed);
      box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 30px 5px var(--border-completed);
    }
    .modal-content.completed ::-webkit-scrollbar-track { background: var(--bg-completed); }
    .modal-content.completed ::-webkit-scrollbar-thumb { background: var(--bg-completed-well); border-color: var(--bg-completed); }

    .modal-content.active {
      opacity: 1; top: 50% !important; left: 50% !important;
      transform: translate(-50%, -50%) scale(1); pointer-events: auto;
    }

    .modal-header {
      font-size: 1.8rem; margin-bottom: 12px; text-align: center;
      font-weight: bold; color: var(--text-main);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    .modal-content.completed .modal-header { color: var(--text-completed); }

    .modal-img { height: 250px; margin-bottom: 12px; display: flex; justify-content: center; }
    .modal-img img { max-height: 100%; filter: drop-shadow(4px 4px 6px black); }

    .modal-label { font-size: 0.7rem; text-transform: uppercase; font-weight: bold; margin-bottom: 2px; color: var(--text-main); }
    .modal-content.completed .modal-label { color: var(--text-completed); }

    .modal-points-inline {
      font-size: 0.85rem; background: var(--bg-well);
      border: 1px solid var(--accent); padding: 1px 6px;
      border-radius: 4px; font-weight: bold; color: var(--text-main);
    }
    .modal-content.completed .modal-points-inline {
      border-color: var(--border-completed); color: var(--text-completed);
      background: var(--bg-completed-well);
    }

    .modal-checklist, .modal-description {
      background: var(--bg-well); border: 1px solid #000;
      padding: 8px; overflow-y: auto; color: var(--text-bright);
    }
    .modal-content.completed .modal-checklist,
    .modal-content.completed .modal-description {
      background: var(--bg-completed-well); color: var(--text-completed);
    }
    .modal-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; min-height: 30px; }

    .modal-map-btn {
      background: none; border: none; padding: 4px; cursor: pointer;
      color: var(--text-dim); display: flex; align-items: center;
      justify-content: center; border-radius: 4px; transition: all 0.2s ease;
    }
    .modal-map-btn:hover { color: var(--accent); background: var(--bg-well); }
    .modal-map-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .modal-map-btn svg { width: 22px; height: 22px; fill: currentColor; }

    .modal-close-btn {
      background: none; border: none; padding: 4px; cursor: pointer;
      color: var(--text-dim); display: flex; align-items: center;
      justify-content: center; font-size: 2rem; line-height: 1;
      transition: all 0.2s ease; border-radius: 4px;
    }
    .modal-close-btn:hover { color: var(--accent); background: var(--bg-well); }
    .modal-close-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .modal-content.completed .modal-map-btn,
    .modal-content.completed .modal-close-btn {
      color: var(--text-completed);
    }
    .modal-content.completed .modal-map-btn:hover,
    .modal-content.completed .modal-close-btn:hover {
      color: var(--bg-completed); background: var(--text-completed);
    }
    .modal-content.completed .modal-map-btn:focus-visible,
    .modal-content.completed .modal-close-btn:focus-visible {
      outline-color: var(--text-completed);
    }

    .large-map-grid {
      display: grid; grid-template-columns: repeat(var(--grid-cols, 7), 1fr);
      gap: 5px; background: var(--bg-body); padding: 10px;
      border: 2px solid var(--border-main); width: 100%; aspect-ratio: 1/1;
    }
    .large-map-tile {
      background: var(--bg-well); display: flex;
      justify-content: center; align-items: center;
      font-size: 1.2rem; font-weight: bold;
      color: rgba(255,255,255,0.2); border: 1px solid var(--bg-tile);
      cursor: pointer; transition: 0.2s;
    }
    .large-map-tile:hover { background: var(--bg-tile); color: #fff; transform: scale(1.05); z-index: 2; border-color: var(--accent); }
    .large-map-tile.complete { background: var(--bg-completed); color: var(--text-completed); border-color: var(--border-completed); }
    .large-map-tile:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .settings-section { margin-bottom: 18px; }
    .settings-section-title {
      font-size: 0.75rem; text-transform: uppercase; font-weight: bold;
      color: var(--text-dim); letter-spacing: 1px; margin-bottom: 8px;
      padding-bottom: 4px; border-bottom: 1px solid var(--border-main);
    }
    .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    .settings-row-label { font-size: 1rem; color: var(--text-bright); }
    .settings-row-hint { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; }
    .settings-select {
      background: var(--bg-well); color: var(--text-main);
      border: 1px solid var(--border-main); padding: 5px 10px;
      font-family: 'Cabin Condensed'; cursor: pointer;
      font-size: 1rem; border-radius: 4px; min-width: 140px;
    }
    .settings-select:focus { border-color: var(--accent); outline: none; }
    .settings-version {
      text-align: center; font-size: 0.7rem; color: var(--text-dim);
      margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-main);
    }

    .page-footer {
      width: 100%; max-width: 1580px; padding: 15px 0 10px 0;
      font-size: 0.65rem; color: var(--border-main);
      display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
    }
    .sync-btn { cursor: pointer; color: var(--text-dim); text-decoration: underline; }
    .sync-btn:hover { color: var(--accent); }
    .sync-flash { animation: flash-sync 1s ease-out; }
    @keyframes flash-sync { 0% { color: var(--accent); } 100% { color: var(--border-main); } }
    .sync-error { color: var(--danger); }

    /* --- Custom Theme Editor --- */
    .theme-editor-toggle { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    .theme-editor-btn {
      background: var(--bg-well); border: 1px solid var(--border-main);
      color: var(--text-main); padding: 5px 12px;
      font-family: 'Cabin Condensed', sans-serif; font-size: 0.85rem;
      cursor: pointer; border-radius: 4px; transition: all 0.2s ease;
    }
    .theme-editor-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--bg-tile); }
    .theme-editor-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .theme-editor-btn.danger { border-color: var(--danger); color: var(--danger); }
    .theme-editor-btn.danger:hover { background: var(--danger); color: #000; }

    .theme-editor-grid {
      display: none; flex-direction: column; gap: 6px; margin-top: 10px;
      padding: 10px; background: var(--bg-well); border: 1px solid var(--border-main);
      border-radius: 4px; max-height: 260px; overflow-y: auto;
    }
    .theme-editor-grid.open { display: flex; }

    .color-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 3px 0; }
    .color-row-label {
      font-size: 0.8rem; color: var(--text-bright); flex: 1; min-width: 0;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .color-row-controls { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    .color-picker-wrapper {
      position: relative; width: 32px; height: 26px;
      border: 2px solid var(--border-main); border-radius: 3px;
      overflow: hidden; cursor: pointer; transition: border-color 0.2s ease;
    }
    .color-picker-wrapper:hover { border-color: var(--accent); }
    .color-picker-wrapper input[type="color"] {
      position: absolute; top: -4px; left: -4px;
      width: calc(100% + 8px); height: calc(100% + 8px);
      border: none; cursor: pointer; padding: 0; background: none;
    }
    .color-hex-input {
      width: 72px; background: var(--bg-body); border: 1px solid var(--border-main);
      color: var(--text-bright); font-family: 'Cabin Condensed', monospace;
      font-size: 0.8rem; padding: 3px 6px; border-radius: 3px; text-transform: lowercase;
    }
    .color-hex-input:focus { border-color: var(--accent); outline: none; }
    .color-hex-input.invalid { border-color: var(--danger); color: var(--danger); }

    .theme-editor-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .theme-editor-name-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .theme-name-input {
      flex: 1; background: var(--bg-body); border: 1px solid var(--border-main);
      color: var(--text-bright); font-family: 'Cabin Condensed', sans-serif;
      font-size: 0.9rem; padding: 4px 8px; border-radius: 3px;
    }
    .theme-name-input:focus { border-color: var(--accent); outline: none; }

    .custom-theme-list { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
    .custom-theme-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 4px 8px; background: var(--bg-body);
      border: 1px solid var(--border-main); border-radius: 3px;
    }
    .custom-theme-item-name {
      font-size: 0.85rem; color: var(--text-bright); cursor: pointer;
      flex: 1; padding: 2px 0;
    }
    .custom-theme-item-name:hover { color: var(--accent); }
    .custom-theme-item-actions { display: flex; gap: 4px; flex-shrink: 0; }

    .mini-btn {
      background: none; border: 1px solid var(--border-main);
      color: var(--text-dim); font-size: 0.7rem; padding: 2px 6px;
      cursor: pointer; border-radius: 2px; font-family: 'Cabin Condensed', sans-serif;
      transition: all 0.2s ease;
    }
    .mini-btn:hover { border-color: var(--accent); color: var(--accent); }
    .mini-btn.del:hover { border-color: var(--danger); color: var(--danger); }
    .mini-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 1px; }

    .theme-editor-toast {
      font-size: 0.75rem; color: var(--text-completed);
      opacity: 0; transition: opacity 0.3s ease; min-height: 1.2em;
    }
    .theme-editor-toast.show { opacity: 1; }

    .theme-editor-import-export { display: flex; gap: 6px; margin-top: 8px; }
    .theme-export-area {
      width: 100%; min-height: 60px; max-height: 100px;
      background: var(--bg-body); border: 1px solid var(--border-main);
      color: var(--text-bright); font-family: 'Cabin Condensed', monospace;
      font-size: 0.7rem; padding: 6px; border-radius: 3px;
      resize: vertical; margin-top: 6px;
    }
    .theme-export-area:focus { border-color: var(--accent); outline: none; }

    /* --- Event Description Bar --- */
    .event-desc-bar {
      width: 100%; max-width: 1580px;
      background: var(--bg-tile); border: 2px solid var(--border-main);
      padding: 10px 18px; margin-bottom: 14px;
      display: flex; justify-content: space-between; align-items: center;
      gap: 12px; border-left: 4px solid var(--accent);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .event-desc-bar-content {
      display: flex; align-items: flex-start; gap: 10px;
      flex: 1; min-width: 0;
    }
    .event-desc-bar-icon {
      font-size: 1.1rem; flex-shrink: 0; line-height: 1.5;
    }
    .event-desc-bar-text {
      font-size: 0.85rem; color: var(--text-bright);
      line-height: 1.5; white-space: pre-line;
      overflow: hidden;
    }
    .event-desc-bar-close {
      background: none; border: none; color: var(--text-dim);
      font-size: 1.3rem; cursor: pointer; padding: 0 4px;
      line-height: 1; flex-shrink: 0;
      transition: color 0.2s ease;
    }
    .event-desc-bar-close:hover { color: var(--accent); }
    .event-desc-bar-close:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    /* --- Responsive --- */
    @media (max-width: 1400px) {
      .grid-container { grid-template-columns: repeat(var(--grid-cols-tablet, 5), 1fr); }
      .minimap-wrapper.in-dashboard { display: none; }
      .minimap-wrapper.floating {
        display: block; position: fixed; bottom: 20px; right: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.7);
        background: var(--bg-well); border: 2px solid var(--border-main); z-index: 1000;
      }
      .minimap-wrapper.floating .minimap-container { grid-template-columns: repeat(var(--grid-cols, 7), 12px); grid-template-rows: repeat(var(--grid-rows, 7), 12px); }
      .minimap-wrapper.floating .mini-tile { width: 12px; height: 12px; font-size: 7px; }
    }
    @media (min-width: 1401px) { .minimap-wrapper.floating { display: none; } }
    @media (max-width: 1000px) { .grid-container { grid-template-columns: repeat(var(--grid-cols-mobile, 4), 1fr); } }
    @media (max-width: 768px) {
      body { padding: 8px; }
      .dashboard { padding: 8px 12px; gap: 6px; }
      .dashboard-main { flex-basis: calc(100% - 50px); }
      #event-title { font-size: 1.2rem; }
      #team-name { font-size: 0.9rem; }
      .stats-container { order: 3; flex-basis: 100%; justify-content: center; gap: 12px; padding-top: 6px; border-top: 1px solid var(--border-main); }
      .stat-value { font-size: 1.1rem; }
      #codeword-display { min-width: 70px; padding: 2px 8px; }
      .settings-btn { order: 2; }
      .event-desc-bar { padding: 8px 12px; }
      .event-desc-bar-text { font-size: 0.8rem; }
    }
    @media (max-width: 600px) {
      .grid-container { grid-template-columns: repeat(var(--grid-cols-small, 3), 1fr); }
      .dashboard { padding: 6px 10px; }
      #event-title { font-size: 1rem; }
      #team-name { font-size: 0.8rem; }
      .stats-container { gap: 10px; }
      .stat-label { font-size: 0.6rem; }
      .stat-value { font-size: 1rem; }
    }
    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; scroll-behavior: auto !important; }
      .tile:hover { transform: none !important; }
      .minimap-wrapper:hover { transform: none !important; }
    }
  </style>
</head>
<body>
  <header class="dashboard" role="banner">
    <div class="dashboard-main">
      <h1 id="event-title">Bingo 2026</h1>
      <p id="team-name">Loading Team...</p>
    </div>

    <div class="stats-container">
      <div class="stat-item">
        <span class="stat-label">Codeword</span>
        <span id="codeword-display" class="stat-value codeword-hidden"
              role="button" tabindex="0" aria-label="Codeword hidden. Click to reveal.">?????</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Points</span>
        <span id="total-points" class="stat-value" aria-live="polite">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Completed</span>
        <span id="completed-count" class="stat-value" aria-live="polite">0/49</span>
      </div>
    </div>

    <aside class="minimap-wrapper in-dashboard" id="mini-map-trigger"
           role="button" tabindex="0" aria-label="Open overview map">
      <div class="minimap-container" id="minimap" aria-hidden="true"></div>
    </aside>

    <a href="admin.html" class="settings-btn" id="admin-back-btn" style="display:none; margin-right:8px; text-decoration:none;" aria-label="Back to Admin">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      <span>Admin</span>
    </a>
    <button class="settings-btn" id="settings-trigger" aria-label="Open settings">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.611 3.611 0 0112 15.6z"/>
      </svg>
    </button>
  </header>

  <aside class="minimap-wrapper floating" id="mini-map-floating"
         role="button" tabindex="0" aria-label="Open overview map">
    <div class="minimap-container" id="minimap-floating" aria-hidden="true"></div>
  </aside>

  <!-- Event Description -->
  <div class="event-desc-bar" id="event-desc-bar" style="display:none;">
    <div class="event-desc-bar-content">
      <span class="event-desc-bar-icon">ðŸ“œ</span>
      <span class="event-desc-bar-text" id="event-desc-bar-text"></span>
    </div>
    <button class="event-desc-bar-close" id="event-desc-bar-close" aria-label="Dismiss">&times;</button>
  </div>

  <main class="grid-container" id="grid" role="grid" aria-label="Bingo board"></main>

  <footer class="page-footer">
    <span>v3.302</span>
    <span>&middot;</span>
    <span id="last-sync-text" aria-live="polite">Last Sync: Never</span>
    <span class="sync-btn" id="sync-now" role="button" tabindex="0">[Sync Now]</span>
  </footer>

  <div id="modal-overlay" role="dialog" aria-modal="true" aria-label="Dialog">
    <div class="modal-content" id="modal-box" aria-label="Dialog panel">

      <!-- Standard Tile View -->
      <div id="standard-modal-view">
        <div class="modal-top-bar">
          <button class="modal-map-btn" id="modal-map-back" aria-label="Back to overview map" tabindex="0">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
          </button>
          <button class="modal-close-btn" aria-label="Close dialog" tabindex="0">&times;</button>
        </div>
        <div id="modal-header" class="modal-header"></div>
        <div class="modal-img"><img id="modal-image" src="" alt=""></div>
        <div id="modal-progress-section">
          <div class="modal-label">Progress</div>
          <div style="height: 12px; margin-bottom: 12px;">
            <div class="progress-bg"><div id="modal-bar" class="progress-fill"></div></div>
          </div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2px;">
          <div class="modal-label">Collected Items</div>
          <div id="modal-points" class="modal-points-inline">0 PTS</div>
        </div>
        <div id="modal-list" class="modal-checklist" style="max-height: 130px; margin-bottom: 12px;"></div>
        <div class="modal-label">Description</div>
        <div id="modal-desc" class="modal-description" style="max-height: 80px;"></div>
      </div>

      <!-- Map Overview View -->
      <div id="map-modal-view" style="display: none; flex-direction: column; align-items: center;">
        <div class="modal-top-bar" style="width: 100%;">
          <div></div>
          <button class="modal-close-btn" aria-label="Close dialog" tabindex="0">&times;</button>
        </div>
        <div class="modal-header" style="margin-top: 0;">OVERVIEW</div>
        <div class="large-map-grid" id="large-map-grid"></div>
      </div>

      <!-- Settings View -->
      <div id="settings-modal-view" style="display: none; flex-direction: column;">
        <div class="modal-top-bar">
          <div></div>
          <button class="modal-close-btn" aria-label="Close dialog" tabindex="0">&times;</button>
        </div>
        <div class="modal-header" style="margin-top: 0;">SETTINGS</div>

        <div style="max-height: 65vh; overflow-y: auto; padding-right: 4px;">
          <!-- Appearance Section -->
          <div class="settings-section">
            <div class="settings-section-title">Appearance</div>
            <div class="settings-row">
              <div>
                <div class="settings-row-label">Theme</div>
                <div class="settings-row-hint">Choose a visual style</div>
              </div>
              <label for="settings-theme-dropdown" class="sr-only">Select Theme</label>
              <select id="settings-theme-dropdown" class="settings-select">
                <optgroup label="Classic">
                  <option value="osrs">OSRS (Original)</option>
                  <option value="midnight">Midnight OLED</option>
                  <option value="parchment">Parchment</option>
                </optgroup>
                <optgroup label="Seasons">
                  <option value="spring">Spring</option>
                  <option value="summer">Summer</option>
                  <option value="autumn">Autumn</option>
                  <option value="winter">Winter</option>
                </optgroup>
                <optgroup label="Aesthetic">
                  <option value="abyssal">Abyssal</option>
                  <option value="volcanic">Volcanic</option>
                  <option value="cyberpunk">Cyberpunk</option>
                  <option value="bloodlust">Bloodlust</option>
                  <option value="royal">Royal</option>
                  <option value="emerald">Emerald</option>
                  <option value="solar">Solar</option>
                  <option value="vaporwave">Vaporwave</option>
                  <option value="tox">Toxic</option>
                </optgroup>
                <optgroup label="Elements">
                  <option value="ocean">Ocean Depths</option>
                  <option value="frost">Frost</option>
                  <option value="sandstorm">Sandstorm</option>
                  <option value="nebula">Nebula</option>
                  <option value="forest">Enchanted Forest</option>
                </optgroup>
                <optgroup label="Moods">
                  <option value="noir">Film Noir</option>
                  <option value="sakura">Sakura</option>
                  <option value="copper">Copper Patina</option>
                  <option value="arctic">Arctic Aurora</option>
                  <option value="obsidian">Obsidian Gold</option>
                </optgroup>
                <optgroup id="custom-theme-optgroup" label="Custom Themes"></optgroup>
              </select>
            </div>
          </div>

          <!-- Theme Editor Section -->
          <div class="settings-section">
            <div class="settings-section-title">Theme Editor</div>
            <div id="custom-themes-list" class="custom-theme-list"></div>
            <div class="theme-editor-toggle">
              <button class="theme-editor-btn" id="editor-new-btn">+ New Custom Theme</button>
              <button class="theme-editor-btn" id="editor-edit-btn" style="display:none;">Edit Current</button>
            </div>
            <div class="theme-editor-grid" id="theme-editor-panel">
              <div class="theme-editor-name-row">
                <label for="custom-theme-name" class="sr-only">Theme Name</label>
                <input type="text" id="custom-theme-name" class="theme-name-input"
                       placeholder="My Custom Theme" maxlength="30">
              </div>
              <div id="color-rows-container"></div>
              <div class="theme-editor-actions">
                <button class="theme-editor-btn" id="editor-save-btn">Save Theme</button>
                <button class="theme-editor-btn" id="editor-reset-btn">Reset to Base</button>
                <button class="theme-editor-btn" id="editor-cancel-btn">Cancel</button>
              </div>
              <span class="theme-editor-toast" id="editor-toast"></span>
              <div class="theme-editor-import-export">
                <button class="theme-editor-btn" id="editor-export-btn">Export</button>
                <button class="theme-editor-btn" id="editor-import-btn">Import</button>
              </div>
              <textarea class="theme-export-area" id="editor-io-area"
                        placeholder="Paste theme JSON here to import..." style="display:none;"></textarea>
            </div>
          </div>

          <!-- Data Section -->
          <div class="settings-section">
            <div class="settings-section-title">Data</div>
            <div class="settings-row">
              <div>
                <div class="settings-row-label">Sync Interval</div>
                <div class="settings-row-hint">How often to refresh data</div>
              </div>
              <select id="settings-sync-interval" class="settings-select">
                <option value="15000">15 seconds</option>
                <option value="30000" selected>30 seconds</option>
                <option value="60000">1 minute</option>
                <option value="120000">2 minutes</option>
                <option value="300000">5 minutes</option>
              </select>
            </div>
          </div>
        </div>

        <div class="settings-version">Bingo Board &middot; v3.302</div>
      </div>
    </div>
  </div>

  <script>
(() => {
  const APP_VERSION = '3.302';
  let maxTiles = 49;
  let gridCols = 7;
  let gridRows = 7;

  const STORAGE_KEYS = {
    eventConfig: 'bingo-event-config',
    teams: 'bingo-teams-config',
    tiles: 'bingo-tiles-config',
    completion: 'bingo-completion',
    theme: 'bingo-theme',
    customThemes: 'bingo-custom-themes',
    syncInterval: 'bingo-sync-interval',
    codewordVisible: 'bingo-codeword-visible'
  };

  const THEME_VARS = [
    '--bg-body','--bg-tile','--bg-well','--bg-completed','--bg-completed-well',
    '--border-main','--border-completed','--accent',
    '--text-main','--text-bright','--text-dim','--text-completed'
  ];

  const THEMES = {
    osrs: null,
    midnight: {
      '--bg-body':'#000000','--bg-tile':'#0e0e0e','--bg-well':'#060606',
      '--bg-completed':'#1a1a1a','--bg-completed-well':'#0d0d0d',
      '--border-main':'#2a2a2a','--border-completed':'#e0e0e0',
      '--accent':'#ffffff','--text-main':'#d4d4d4','--text-bright':'#ffffff',
      '--text-dim':'#4a4a4a','--text-completed':'#e0e0e0'
    },
    parchment: {
      '--bg-body':'#2c2416','--bg-tile':'#3d3322','--bg-well':'#241e12',
      '--bg-completed':'#2a3a1e','--bg-completed-well':'#1e2c14',
      '--border-main':'#6b5b3e','--border-completed':'#8aba5a',
      '--accent':'#d4a843','--text-main':'#d4a843','--text-bright':'#f0dca0',
      '--text-dim':'#7a6b50','--text-completed':'#8aba5a'
    },
    spring: {
      '--bg-body':'#1e2e1e','--bg-tile':'#2a402a','--bg-well':'#162416',
      '--bg-completed':'#3d2a4d','--bg-completed-well':'#2a1c36',
      '--border-main':'#5a8a5a','--border-completed':'#c77dff',
      '--accent':'#7dffb3','--text-main':'#7dffb3','--text-bright':'#d0ffe0',
      '--text-dim':'#6a8a6a','--text-completed':'#c77dff'
    },
    summer: {
      '--bg-body':'#0f2a3a','--bg-tile':'#1a4058','--bg-well':'#0a1f2d',
      '--bg-completed':'#5a4010','--bg-completed-well':'#3d2b0a',
      '--border-main':'#3a7ea8','--border-completed':'#ffc833',
      '--accent':'#00e5ff','--text-main':'#00e5ff','--text-bright':'#b3f5ff',
      '--text-dim':'#4a7a8f','--text-completed':'#ffc833'
    },
    autumn: {
      '--bg-body':'#261410','--bg-tile':'#3d2218','--bg-well':'#1a0e0a',
      '--bg-completed':'#1a3040','--bg-completed-well':'#0f1f2a',
      '--border-main':'#8a5040','--border-completed':'#4a9ac4',
      '--accent':'#ff8533','--text-main':'#ff8533','--text-bright':'#ffc599',
      '--text-dim':'#8a6a5a','--text-completed':'#4a9ac4'
    },
    winter: {
      '--bg-body':'#141a22','--bg-tile':'#222e3a','--bg-well':'#0e1419',
      '--bg-completed':'#3a2228','--bg-completed-well':'#261418',
      '--border-main':'#4a6a82','--border-completed':'#ff7a7a',
      '--accent':'#8ad4ff','--text-main':'#8ad4ff','--text-bright':'#d6efff',
      '--text-dim':'#5a6e7e','--text-completed':'#ff7a7a'
    },
    abyssal: {
      '--bg-body':'#030810','--bg-tile':'#081428','--bg-well':'#020508',
      '--bg-completed':'#003838','--bg-completed-well':'#001f1f',
      '--border-main':'#0e2040','--border-completed':'#50ffd0',
      '--accent':'#50ffd0','--text-main':'#50ffd0','--text-bright':'#b0d8e8',
      '--text-dim':'#3a5070','--text-completed':'#50ffd0'
    },
    volcanic: {
      '--bg-body':'#100808','--bg-tile':'#1e1010','--bg-well':'#080404',
      '--bg-completed':'#401500','--bg-completed-well':'#280e00',
      '--border-main':'#4a2020','--border-completed':'#ff5500',
      '--accent':'#ff5500','--text-main':'#ff6a20','--text-bright':'#ffb380',
      '--text-dim':'#6a4040','--text-completed':'#ff5500'
    },
    cyberpunk: {
      '--bg-body':'#0a0118','--bg-tile':'#1a0a30','--bg-well':'#06010e',
      '--bg-completed':'#80002a','--bg-completed-well':'#500018',
      '--border-main':'#4a1a6a','--border-completed':'#00e8c8',
      '--accent':'#ffe030','--text-main':'#ff1a60','--text-bright':'#ff80a0',
      '--text-dim':'#6a4070','--text-completed':'#00e8c8'
    },
    bloodlust: {
      '--bg-body':'#140404','--bg-tile':'#220808','--bg-well':'#0e0202',
      '--bg-completed':'#400808','--bg-completed-well':'#280404',
      '--border-main':'#4a1414','--border-completed':'#ff4040',
      '--accent':'#ff4040','--text-main':'#e02020','--text-bright':'#ff8080',
      '--text-dim':'#5a3030','--text-completed':'#ff4040'
    },
    royal: {
      '--bg-body':'#160a24','--bg-tile':'#2e1650','--bg-well':'#0e0618',
      '--bg-completed':'#4a3800','--bg-completed-well':'#302400',
      '--border-main':'#4a2870','--border-completed':'#ffd700',
      '--accent':'#ffc830','--text-main':'#c8a030','--text-bright':'#ffe899',
      '--text-dim':'#6a4890','--text-completed':'#ffd700'
    },
    emerald: {
      '--bg-body':'#04160c','--bg-tile':'#0a2e18','--bg-well':'#020e08',
      '--bg-completed':'#104828','--bg-completed-well':'#0a3018',
      '--border-main':'#1a5030','--border-completed':'#30d868',
      '--accent':'#50e880','--text-main':'#50e880','--text-bright':'#a0ffc0',
      '--text-dim':'#2a5a3a','--text-completed':'#30d868'
    },
    solar: {
      '--bg-body':'#2a1e14','--bg-tile':'#44301e','--bg-well':'#1e140e',
      '--bg-completed':'#6a4a08','--bg-completed-well':'#483208',
      '--border-main':'#6a4a30','--border-completed':'#f0c020',
      '--accent':'#ffcc33','--text-main':'#e8b020','--text-bright':'#fff0b0',
      '--text-dim':'#7a6040','--text-completed':'#f0c020'
    },
    vaporwave: {
      '--bg-body':'#0a0240','--bg-tile':'#1a0830','--bg-well':'#06012a',
      '--bg-completed':'#a0408a','--bg-completed-well':'#6a2860',
      '--border-main':'#3020a0','--border-completed':'#00d8f0',
      '--accent':'#00d8f0','--text-main':'#b070ff','--text-bright':'#e0b0ff',
      '--text-dim':'#5a3880','--text-completed':'#00d8f0'
    },
    tox: {
      '--bg-body':'#100010','--bg-tile':'#200020','--bg-well':'#0a000a',
      '--bg-completed':'#0a200a','--bg-completed-well':'#061406',
      '--border-main':'#400040','--border-completed':'#30ff18',
      '--accent':'#d0ff10','--text-main':'#d0ff10','--text-bright':'#e8ff88',
      '--text-dim':'#604060','--text-completed':'#30ff18'
    },
    ocean: {
      '--bg-body':'#040e1a','--bg-tile':'#0a1e30','--bg-well':'#02080f',
      '--bg-completed':'#004048','--bg-completed-well':'#002830',
      '--border-main':'#10304a','--border-completed':'#00c8a0',
      '--accent':'#0090d0','--text-main':'#40b8e8','--text-bright':'#90e0ff',
      '--text-dim':'#2a5068','--text-completed':'#00c8a0'
    },
    frost: {
      '--bg-body':'#0c1420','--bg-tile':'#162030','--bg-well':'#080e18',
      '--bg-completed':'#183048','--bg-completed-well':'#102038',
      '--border-main':'#304868','--border-completed':'#90d8ff',
      '--accent':'#b0e8ff','--text-main':'#80c8f0','--text-bright':'#d8f0ff',
      '--text-dim':'#406080','--text-completed':'#90d8ff'
    },
    sandstorm: {
      '--bg-body':'#1e1810','--bg-tile':'#302818','--bg-well':'#14100a',
      '--bg-completed':'#484020','--bg-completed-well':'#302a14',
      '--border-main':'#5a4a2a','--border-completed':'#d8b840',
      '--accent':'#e8c848','--text-main':'#d0a830','--text-bright':'#f0dea0',
      '--text-dim':'#6a5a38','--text-completed':'#d8b840'
    },
    nebula: {
      '--bg-body':'#0a0414','--bg-tile':'#140a24','--bg-well':'#06020e',
      '--bg-completed':'#1a1040','--bg-completed-well':'#100a28',
      '--border-main':'#281848','--border-completed':'#c080ff',
      '--accent':'#a060ff','--text-main':'#9070e0','--text-bright':'#d0b8ff',
      '--text-dim':'#443060','--text-completed':'#c080ff'
    },
    forest: {
      '--bg-body':'#0a120a','--bg-tile':'#142014','--bg-well':'#060e06',
      '--bg-completed':'#183818','--bg-completed-well':'#102810',
      '--border-main':'#2a4a2a','--border-completed':'#68d068',
      '--accent':'#88e088','--text-main':'#60c060','--text-bright':'#b0f0b0',
      '--text-dim':'#3a5a3a','--text-completed':'#68d068'
    },
    noir: {
      '--bg-body':'#0e0e0e','--bg-tile':'#1a1a1a','--bg-well':'#080808',
      '--bg-completed':'#2a2a1e','--bg-completed-well':'#1a1a14',
      '--border-main':'#333333','--border-completed':'#c8b870',
      '--accent':'#c8b870','--text-main':'#a0a0a0','--text-bright':'#d8d8d0',
      '--text-dim':'#505050','--text-completed':'#c8b870'
    },
    sakura: {
      '--bg-body':'#1a0e14','--bg-tile':'#2a1824','--bg-well':'#12080e',
      '--bg-completed':'#3a1830','--bg-completed-well':'#281020',
      '--border-main':'#4a2840','--border-completed':'#ff88b8',
      '--accent':'#ff88b8','--text-main':'#e870a0','--text-bright':'#ffc0d8',
      '--text-dim':'#5a3850','--text-completed':'#ff88b8'
    },
    copper: {
      '--bg-body':'#10120e','--bg-tile':'#1e201a','--bg-well':'#0a0c08',
      '--bg-completed':'#2a3028','--bg-completed-well':'#1e2418',
      '--border-main':'#3a4030','--border-completed':'#60b8a0',
      '--accent':'#d08850','--text-main':'#c08048','--text-bright':'#e8c0a0',
      '--text-dim':'#505840','--text-completed':'#60b8a0'
    },
    arctic: {
      '--bg-body':'#060c14','--bg-tile':'#0e1824','--bg-well':'#04080e',
      '--bg-completed':'#0a2030','--bg-completed-well':'#061420',
      '--border-main':'#1a3048','--border-completed':'#30e8a0',
      '--accent':'#40d0a0','--text-main':'#50b8d0','--text-bright':'#a0e8f0',
      '--text-dim':'#2a4860','--text-completed':'#30e8a0'
    },
    obsidian: {
      '--bg-body':'#080808','--bg-tile':'#141410','--bg-well':'#040404',
      '--bg-completed':'#282010','--bg-completed-well':'#1a1408',
      '--border-main':'#2a2820','--border-completed':'#d8a830',
      '--accent':'#d8a830','--text-main':'#c09828','--text-bright':'#f0d888',
      '--text-dim':'#484030','--text-completed':'#d8a830'
    }
  };

  const DEFAULT_TEAMS = {
    'Team1': { name: "Team 1", url: "", points: 0, teamNumber: 1 },
    'Team2': { name: "Team 2", url: "", points: 0, teamNumber: 2 },
    'Team3': { name: "Team 3", url: "", points: 0, teamNumber: 3 },
    'Team4': { name: "Team 4", url: "", points: 0, teamNumber: 4 },
    'Team5': { name: "Team 5", url: "", points: 0, teamNumber: 5 },
    'Team6': { name: "Team 6", url: "", points: 0, teamNumber: 6 },
    'Team7': { name: "Team 7", url: "", points: 0, teamNumber: 7 },
    'Team8': { name: "Team 8", url: "", points: 0, teamNumber: 8 }
  };

  let TEAM_MAP = {};
  let eventConfig = {
    name: 'Bingo 2026',
    codeword: '',
    description: '',
    syncInterval: 30000,
    format: '',
    boardSize: '',
    teamCount: ''
  };
  let currentTeamKey = '';
  let codewordSecret = '';
  let appliedHash = null;
  let candidateHash = null;
  let stabilityCount = 0;
  let completion = Array(maxTiles).fill(false);
  let tiles = Array(maxTiles).fill(null);
  let fetchController = null;
  let syncIntervalId = null;
  let syncMs = 30000;
  let modalOpen = false;
  let lastTriggerEl = null;
  let ghostEl = null;

  async function loadSharedConfig() {
    let loadedRemote = false;
    try {
      const res = await fetch('config.json?t=' + Date.now());
      if (res.ok) {
        const data = await res.json();
        if (data.teams) TEAM_MAP = data.teams;
        if (data.eventConfig) eventConfig = data.eventConfig;
        loadedRemote = true;
      }
    } catch {}

    if (!loadedRemote) {
      // Fallback to localStorage
    try {
      const savedTeams = localStorage.getItem(STORAGE_KEYS.teams);
      TEAM_MAP = savedTeams ? JSON.parse(savedTeams) : { ...DEFAULT_TEAMS };
      } catch { TEAM_MAP = { ...DEFAULT_TEAMS }; }

    try {
      const savedEvent = localStorage.getItem(STORAGE_KEYS.eventConfig);
        if (savedEvent) eventConfig = JSON.parse(savedEvent);
      } catch {}
    }

    // Safety: If TEAM_MAP is empty (e.g. bad config or empty local storage), force defaults
    if (Object.keys(TEAM_MAP).length === 0) {
      TEAM_MAP = { ...DEFAULT_TEAMS };
    }

    // Ensure defaults if missing
    if (!eventConfig.name) {
      eventConfig = {
        name: 'Bingo 2026',
        codeword: '',
        description: '',
        syncInterval: 30000
      };
    }

    // Apply board size if present in config
    if (eventConfig.boardSize) {
      updateBoardSize(eventConfig.boardSize);
    }

    // Get team from URL parameter
    const params = new URLSearchParams(window.location.search);
    const adminMode = params.get('admin') === 'true';
    
    const teamKeys = Object.keys(TEAM_MAP);

    // If requesting a specific team
    if (params.get('team')) {
      if (TEAM_MAP[params.get('team')]) {
        currentTeamKey = params.get('team');
      } else {
        // Invalid team requested
        currentTeamKey = '';
      }
    } else if (adminMode && teamKeys.length > 0) {
      // Admin mode: show team selector
      currentTeamKey = teamKeys[0];
    } else if (teamKeys.length > 0) {
      // Non-admin: default to first team (shouldn't happen in production)
      currentTeamKey = teamKeys[0];
    } else {
      currentTeamKey = '';
    }
  }

  const $ = (id) => document.getElementById(id);
  const DOM = {
    teamName: $('team-name'),
    totalPoints: $('total-points'),
    completedCount: $('completed-count'),
    codeword: $('codeword-display'),
    grid: $('grid'),
    lastSync: $('last-sync-text'),
    syncNow: $('sync-now'),
    settingsTrigger: $('settings-trigger'),
    miniDash: $('mini-map-trigger'),
    miniFloat: $('mini-map-floating'),
    overlay: $('modal-overlay'),
    box: $('modal-box'),
    viewStd: $('standard-modal-view'),
    viewMap: $('map-modal-view'),
    viewSettings: $('settings-modal-view'),
    modalHeader: $('modal-header'),
    modalImage: $('modal-image'),
    modalProgressSection: $('modal-progress-section'),
    modalBar: $('modal-bar'),
    modalList: $('modal-list'),
    modalDesc: $('modal-desc'),
    modalPoints: $('modal-points'),
    mapBack: $('modal-map-back'),
    bigMap: $('large-map-grid'),
    themeSel: $('settings-theme-dropdown'),
    intervalSel: $('settings-sync-interval'),
    editorPanel: $('theme-editor-panel'),
    editorNewBtn: $('editor-new-btn'),
    editorEditBtn: $('editor-edit-btn'),
    editorSaveBtn: $('editor-save-btn'),
    editorResetBtn: $('editor-reset-btn'),
    editorCancelBtn: $('editor-cancel-btn'),
    editorToast: $('editor-toast'),
    editorExportBtn: $('editor-export-btn'),
    editorImportBtn: $('editor-import-btn'),
    editorIOArea: $('editor-io-area'),
    colorRows: $('color-rows-container'),
    customThemeName: $('custom-theme-name'),
    customThemeList: $('custom-themes-list'),
    customOptgroup: $('custom-theme-optgroup'),
    descBar: $('event-desc-bar'),
    descBarText: $('event-desc-bar-text'),
    descBarClose: $('event-desc-bar-close'),
  };

  let miniNodes = [];

  /* ========================= UTILS ========================= */
  const storageSave = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
  const storageLoad = (k, fb) => {
    try {
      const v = localStorage.getItem(k);
      return v ? JSON.parse(v) : fb;
    } catch {
      return fb;
    }
  };
  const normalizeNL = (s) => String(s).replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const simpleHash = (str) => {
    let h = 0;
    for (let i = 0; i < str.length; i++) { h = ((h << 5) - h) + str.charCodeAt(i); h |= 0; }
    return h;
  };
  const escapeHTML = (str) => {
    const d = document.createElement('div');
    d.appendChild(document.createTextNode(String(str ?? '')));
    return d.innerHTML;
  };

  const parseCSVRow = (row) => {
    const cols = []; let cur = '', inQ = false;
    for (let i = 0; i < row.length; i++) {
      const ch = row[i];
      if (inQ) {
        if (ch === '"' && row[i + 1] === '"') { cur += '"'; i++; }
        else if (ch === '"') inQ = false;
        else cur += ch;
      } else {
        if (ch === '"') inQ = true;
        else if (ch === ',') { cols.push(cur.trim()); cur = ''; }
        else cur += ch;
      }
    }
    cols.push(cur.trim());
    return cols;
  };

  const getProgressColor = (pct) => {
    if (pct >= 100) return 'var(--text-completed)';
    const hue = (pct * 120) / 100;
    return `hsl(${hue}, 70%, 45%)`;
  };

  const handleImgError = (img) => {
    img.style.visibility = 'hidden';
    img.removeAttribute('src');
  };

  const safeImgSrc = (imgName) => {
    const raw = String(imgName || '').trim();
    if (!raw) return '';
    if (/^https?:\/\//i.test(raw)) return raw;
    const parts = raw.replace(/\\/g, '/').split('/').filter(Boolean).filter(p => p !== '.' && p !== '..');
    return `./images/${parts.map(encodeURIComponent).join('/')}`;
  };

  const setMinimapComplete = (id1, done) => {
    for (const n of miniNodes[id1]) n.classList.toggle('complete', !!done);
  };
  const resetMinimaps = () => { for (let i = 1; i <= maxTiles; i++) setMinimapComplete(i, false); };
  const updateCompletedStat = () => {
    const done = completion.reduce((a, v) => a + (v ? 1 : 0), 0);
    DOM.completedCount.innerText = `${done}/${maxTiles}`;
  };
  const flashSync = () => {
    DOM.lastSync.classList.remove('sync-error');
    DOM.lastSync.innerText = `Last Sync: ${new Date().toLocaleTimeString()}`;
    DOM.lastSync.classList.remove('sync-flash');
    void DOM.lastSync.offsetWidth;
    DOM.lastSync.classList.add('sync-flash');
  };
  const syncError = (msg) => {
    DOM.lastSync.classList.add('sync-error');
    DOM.lastSync.innerText = `Sync failed: ${msg}`;
  };

  /* ========================= THEME APPLY ========================= */
  const applyTheme = (name) => {
    const root = document.documentElement;
    for (const k of THEME_VARS) root.style.setProperty(k, '');
    const t = THEMES[name];
    if (t) for (const [k, v] of Object.entries(t)) root.style.setProperty(k, v);
    storageSave(STORAGE_KEYS.theme, name);
    if (DOM.themeSel) DOM.themeSel.value = name;
  };

  /* ========================= MINIMAPS BUILD ========================= */
  const buildMinimap = (containerId) => {
    const el = $(containerId);
    if (!el) return;
    el.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (let i = 1; i <= maxTiles; i++) {
      const d = document.createElement('div');
      d.className = 'mini-tile';
      d.dataset.index = String(i);
      d.innerText = String(i);
      frag.appendChild(d);
      if (!miniNodes[i]) miniNodes[i] = [];
      miniNodes[i].push(d);
    }
    el.appendChild(frag);
  };

  /* ========================= RENDER ========================= */
  const renderGrid = () => {
    const container = $('grid');
    if (!container) return;
    container.innerHTML = '';

    for (let i = 0; i < tiles.length; i++) {
      const tile = tiles[i];
      
      const cell = document.createElement('div');
      cell.className = 'tile' + (tile.isCompleted ? ' completed' : '') + (tile.noData ? ' no-data' : '');
      cell.id = 'tile-' + tile.id;
      cell.dataset.tileIndex = String(i);
      cell.setAttribute('role', 'button');
      cell.setAttribute('tabindex', '0');

      const headerBox = document.createElement('div');
      headerBox.className = 'header-box';
      headerBox.innerHTML = `<div class="header-content">${tile.id} | ${escapeHTML(tile.title)}</div>`;

      const imgContainer = document.createElement('div');
      imgContainer.className = 'img-container';
      if (tile.img) {
        const img = document.createElement('img');
        img.src = tile.img;
        img.alt = escapeHTML(tile.title);
        img.onerror = () => handleImgError(img);
        imgContainer.appendChild(img);
      }

      const progressContainer = document.createElement('div');
      progressContainer.className = 'progress-container';
      progressContainer.innerHTML = `
        <div class="progress-bg">
          <div class="progress-fill" style="width:${tile.percent}%; background-color:${tile.barColor};"></div>
        </div>
      `;

      const checklistBox = document.createElement('div');
      checklistBox.className = 'checklist-box';
      checklistBox.innerHTML = tile.checklistHtml || '';

      const pointBadge = document.createElement('div');
      pointBadge.className = 'point-badge';
      pointBadge.textContent = `${tile.points} PTS`;

      cell.appendChild(headerBox);
      cell.appendChild(imgContainer);
      cell.appendChild(progressContainer);
      cell.appendChild(checklistBox);
      cell.appendChild(pointBadge);

      cell.addEventListener('click', () => openTileModalByIndex(i, cell));
      cell.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openTileModalByIndex(i, cell);
        }
      });

      container.appendChild(cell);
    }
  };

  const buildBigMap = () => {
    DOM.bigMap.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (let i = 1; i <= maxTiles; i++) {
      const cell = document.createElement('div');
      cell.className = `large-map-tile${completion[i - 1] ? ' complete' : ''}`;
      cell.dataset.index = String(i);
      cell.innerText = String(i);
      cell.tabIndex = 0;
      cell.setAttribute('role', 'button');
      frag.appendChild(cell);
    }
    DOM.bigMap.appendChild(frag);
  };

  /* ========================= MODAL ========================= */
  const hideViews = () => {
    DOM.viewStd.style.display = 'none';
    DOM.viewMap.style.display = 'none';
    DOM.viewSettings.style.display = 'none';
  };

  const showModal = (triggerEl, animate = true) => {
    if (ghostEl?.isConnected) ghostEl.classList.remove('ghost');
    lastTriggerEl = triggerEl || lastTriggerEl;
    ghostEl = triggerEl;
    if (ghostEl?.classList?.contains('tile') || ghostEl?.id === 'mini-map-trigger' || ghostEl?.id === 'mini-map-floating') {
      ghostEl.classList.add('ghost');
    }
    const rect = (animate && triggerEl?.getBoundingClientRect)
      ? triggerEl.getBoundingClientRect()
      : { top: innerHeight / 2, left: innerWidth / 2, height: 0, width: 0 };
    DOM.box.style.top = (rect.top + rect.height / 2) + 'px';
    DOM.box.style.left = (rect.left + rect.width / 2) + 'px';
    DOM.overlay.style.display = 'flex';
    setTimeout(() => {
      DOM.overlay.classList.add('active');
      DOM.box.classList.add('active');
      modalOpen = true;
      DOM.box.querySelector('.modal-close-btn')?.focus();
    }, 10);
    document.body.style.overflow = 'hidden';
  };

  const closeModal = () => {
    DOM.overlay.classList.remove('active');
    DOM.box.classList.remove('active');
    modalOpen = false;
    if (ghostEl?.isConnected) ghostEl.classList.remove('ghost');
    setTimeout(() => {
      DOM.overlay.style.display = 'none';
      document.body.style.overflow = 'auto';
      lastTriggerEl?.focus?.();
    }, 500);
  };

  const openTileModalByIndex = (tileIndex, triggerEl) => {
    const t = tiles[tileIndex];
    if (!t || t.noData) return;
    
    DOM.box.classList.toggle('completed', !!t.isCompleted);
    hideViews();
    DOM.viewStd.style.display = 'block';
    
    DOM.modalHeader.innerText = `${t.id} | ${t.title}`;
    DOM.modalPoints.innerText = `${t.points} PTS`;
    DOM.modalProgressSection.style.display = t.isCompleted ? 'none' : 'block';
    DOM.modalBar.style.width = t.percent + '%';
    DOM.modalBar.style.backgroundColor = t.barColor;
    DOM.modalList.innerHTML = t.checklistHtml || '';
    DOM.modalDesc.innerText = t.description || '(No description)';
    
    DOM.modalImage.src = '';
    DOM.modalImage.onerror = null;
    DOM.modalImage.style.visibility = 'visible';
    DOM.modalImage.alt = t.title;
    
    if (t.img) {
      DOM.modalImage.onerror = () => handleImgError(DOM.modalImage);
      DOM.modalImage.src = t.img;
    } else {
      handleImgError(DOM.modalImage);
    }
    
    showModal(triggerEl, true);
  };

  const openMapModal = (triggerEl) => {
    DOM.box.classList.remove('completed');
    hideViews();
    DOM.viewMap.style.display = 'flex';
    buildBigMap();
    showModal(triggerEl, true);
  };

  const openSettingsModal = (triggerEl) => {
    DOM.box.classList.remove('completed');
    hideViews();
    DOM.viewSettings.style.display = 'flex';
    DOM.themeSel.value = storageLoad(STORAGE_KEYS.theme, 'osrs');
    DOM.intervalSel.value = String(syncMs);
    
    ThemeEditor.refreshCustomDropdown();
    ThemeEditor.refreshCustomList();
    ThemeEditor.updateEditButton();
    showModal(triggerEl, true);
  };

  /* ========================= CODEWORD ========================= */
  const setCodewordVisible = (visible) => {
    DOM.codeword.classList.toggle('codeword-hidden', !visible);
    DOM.codeword.innerText = visible ? (codewordSecret || '') : '?????';
    DOM.codeword.setAttribute('aria-label',
      visible ? `Codeword: ${codewordSecret}. Click to hide.` : 'Codeword hidden. Click to reveal.'
    );
    storageSave(STORAGE_KEYS.codewordVisible, visible ? '1' : '0');
  };
  const toggleCodeword = () => setCodewordVisible(DOM.codeword.classList.contains('codeword-hidden'));

  /* ========================= FETCH ========================= */
  const fetchGlobal = () => {
    // Update event title
    const titleEl = document.getElementById('event-title');
    if (titleEl) titleEl.innerText = eventConfig.name || 'Bingo 2026';

    if (!currentTeamKey || !TEAM_MAP[currentTeamKey]) {
      DOM.teamName.innerText = 'No team configured';
      DOM.totalPoints.innerText = '0';
      codewordSecret = '';
      return;
    }

    const t = TEAM_MAP[currentTeamKey];
    DOM.teamName.innerText = t.name || currentTeamKey;
    DOM.totalPoints.innerText = Number(t.points || 0).toLocaleString();
    codewordSecret = eventConfig.codeword || '';
  };

  const renderEventDescription = () => {
    if (!eventConfig.description || !eventConfig.description.trim()) {
      DOM.descBar.style.display = 'none';
      return;
    }
    
    const dismissed = sessionStorage.getItem('bingo-desc-dismissed');
    if (dismissed === '1') {
      DOM.descBar.style.display = 'none';
      return;
    }
    
    DOM.descBarText.textContent = eventConfig.description;
    DOM.descBar.style.display = 'flex';
  };

  const updateBoardSize = (sizeStr) => {
    let c = 7, r = 7;
    if (sizeStr && typeof sizeStr === 'string') {
      const parts = sizeStr.toLowerCase().split('x');
      if (parts.length === 2) {
        c = parseInt(parts[0].trim()) || 7;
        r = parseInt(parts[1].trim()) || 7;
      }
    }
    if (c !== gridCols || r !== gridRows) {
      gridCols = c; gridRows = r; maxTiles = c * r;
      document.documentElement.style.setProperty('--grid-cols', gridCols);
      document.documentElement.style.setProperty('--grid-rows', gridRows);
      document.documentElement.style.setProperty('--grid-cols-tablet', Math.min(5, gridCols));
      document.documentElement.style.setProperty('--grid-cols-mobile', Math.min(4, gridCols));
      document.documentElement.style.setProperty('--grid-cols-small', Math.min(3, gridCols));
    }
  };

  async function fetchData(manual = false) {
    // Guard: no team configured
    if (!currentTeamKey || !TEAM_MAP[currentTeamKey]) {
      console.warn('No team configured, skipping fetch.');
      syncError('No team configured');

      // Fill grid with empty tiles so it doesn't stay blank
      tiles = Array(maxTiles).fill(null).map((_, i) => ({
        id: i + 1, title: 'No Data', img: '', percent: 0,
        barColor: getProgressColor(0), checklistHtml: '',
        description: '', isCompleted: false, points: '0', noData: true
      }));
      renderGrid();
      updateCompletedStat();
      return;
    }

    if (fetchController) fetchController.abort();
    fetchController = new AbortController();

    try {
      const team = TEAM_MAP[currentTeamKey];

      if (!team.url) {
        syncError('No CSV URL configured');
        return;
      }

      const res = await fetch(`${team.url}&t=${Date.now()}`, {
        headers: { 'pragma': 'no-cache', 'cache-control': 'no-cache' },
        signal: fetchController.signal
      });
      const raw = normalizeNL(await res.text());
      const h = simpleHash(raw);

      if (manual) {
        // Manual sync: trust immediately
        appliedHash = h;
        candidateHash = null;
        stabilityCount = 0;
      } else {
        // Auto sync: Stability Check
        if (appliedHash === null) {
          appliedHash = h;
        } else if (h === appliedHash) {
          candidateHash = null;
          stabilityCount = 0;
          return; // No change
        } else {
          if (h === candidateHash) {
            stabilityCount++;
          } else {
            candidateHash = h;
            stabilityCount = 1;
          }
          if (stabilityCount < 3) return; // Wait for confirmation
          
          appliedHash = h;
          candidateHash = null;
          stabilityCount = 0;
        }
      }

      flashSync();

      const lines = raw.split('\n');
      
      // Parse Metadata from first data row (index 1) BEFORE init arrays
      if (lines.length > 1) {
        const metaCols = parseCSVRow(lines[1].trim());
        if (metaCols.length >= 5) {
          if (metaCols[0]) eventConfig.name = metaCols[0];
          if (metaCols[1]) eventConfig.codeword = metaCols[1];
          if (metaCols[2]) eventConfig.format = metaCols[2];
          if (metaCols[3]) {
            eventConfig.boardSize = metaCols[3];
            updateBoardSize(eventConfig.boardSize);
          }
          if (metaCols[4]) eventConfig.teamCount = metaCols[4];

          // Dynamic Team Generation based on Count
          const count = parseInt(eventConfig.teamCount, 10);
          if (!isNaN(count) && count > 0) {
            const newTeamMap = {};
            const names = metaCols[5] ? metaCols[5].split(',').map(s => s.trim()) : [];
            
            for (let i = 1; i <= count; i++) {
              const key = `Team${i}`;
              const oldData = TEAM_MAP[key] || DEFAULT_TEAMS[key] || { points: 0 };
              
              newTeamMap[key] = {
                name: names[i-1] || `Team ${i}`,
                url: team.url, // Keep the working URL
                points: oldData.points || 0,
                teamNumber: i
              };
            }
            TEAM_MAP = newTeamMap;
            localStorage.setItem(STORAGE_KEYS.teams, JSON.stringify(TEAM_MAP));
          }
          
          // Save updated config so Admin/Settings can see it
          localStorage.setItem(STORAGE_KEYS.eventConfig, JSON.stringify(eventConfig));
        }
      }

      completion = Array(maxTiles).fill(false);
      tiles = Array(maxTiles).fill(null);
      miniNodes = Array.from({ length: maxTiles + 1 }, () => []);
      buildMinimap('minimap');
      buildMinimap('minimap-floating');

      const teamNumber = team.teamNumber || 1;
      
      // Calculate which columns belong to this team
      // New Format: Metadata(0-5) | TileData(6-9) | TeamData(10+)
      const itemsCol = 10 + ((teamNumber - 1) * 3);
      const currentCol = 11 + ((teamNumber - 1) * 3);
      const goalCol = 12 + ((teamNumber - 1) * 3);

      console.log(`Team: ${currentTeamKey} (Team${teamNumber}), Columns: Items=${itemsCol}, Current=${currentCol}, Goal=${goalCol}`);

      const rows = lines.slice(1);
      let count = 0;
      let calculatedPoints = 0;

      for (const line of rows) {
        if (count >= maxTiles) break;
        if (!line || !line.trim()) continue;
        
        const cols = parseCSVRow(line.trim());
        if (cols.length < 10) continue;

        // Parse Metadata from first data row
        if (count === 0) {
          // Metadata already parsed above, just handle UI updates
          const titleEl = document.getElementById('event-title');
          if (titleEl) titleEl.innerText = eventConfig.name;
          codewordSecret = eventConfig.codeword;

          // Update Team Name from CSV if available (Col 5 = TeamNames)
          if (cols[5]) {
            const names = cols[5].split(',').map(s => s.trim());
            if (names[teamNumber - 1]) {
              DOM.teamName.innerText = names[teamNumber - 1];
              if (TEAM_MAP[currentTeamKey]) TEAM_MAP[currentTeamKey].name = names[teamNumber - 1];
            }
          }
        }
        
        const id = count + 1;
        // Tile Data starts at col 6
        const img = safeImgSrc(cols[6] || '');
        const title = cols[7] || `Tile ${id}`;
        const description = cols[8] || '';
        const pointsVal = parseInt(cols[9], 10) || 0;
        
        const items = cols[itemsCol] ? cols[itemsCol].split(',').map(s => s.trim()).filter(Boolean) : [];
        const current = Math.max(0, parseInt(cols[currentCol], 10) || 0);
        const goal = Math.max(1, parseInt(cols[goalCol], 10) || 1);
        const percent = Math.min((current / goal) * 100, 100);
        const isCompleted = percent === 100;
        if (isCompleted) calculatedPoints += pointsVal;
        
        completion[count] = isCompleted;
        setMinimapComplete(id, isCompleted);
        
        const checklistHtml = items.map(it =>
          `<div class="check-item"><span class="check-mark"></span> ${escapeHTML(it)}</div>`
        ).join('');
        
        tiles[count] = { id, title, img, percent, barColor: getProgressColor(percent), checklistHtml, description, isCompleted, points: pointsVal, noData: false };
        count++;
      }

      for (let i = count; i < maxTiles; i++) {
        tiles[i] = { id: i + 1, title: 'No Data', img: '', percent: 0, barColor: getProgressColor(0), checklistHtml: '', description: '', isCompleted: false, points: '0', noData: true };
      }

      DOM.totalPoints.innerText = calculatedPoints.toLocaleString();
      if (TEAM_MAP[currentTeamKey]) TEAM_MAP[currentTeamKey].points = calculatedPoints;

      renderGrid();
      updateCompletedStat();
    } catch (e) {
      if (e.name !== 'AbortError') { console.error(e); syncError('Network error'); }
    } finally { fetchController = null; }
  }

  /* ========================= THEME EDITOR ========================= */
  const ThemeEditor = (() => {
    const VAR_LABELS = {
      '--bg-body':          'Background',
      '--bg-tile':          'Tile Background',
      '--bg-well':          'Well / Inset',
      '--bg-completed':     'Completed Tile BG',
      '--bg-completed-well':'Completed Well',
      '--border-main':      'Border',
      '--border-completed': 'Completed Border',
      '--accent':           'Accent',
      '--text-main':        'Primary Text',
      '--text-bright':      'Bright Text',
      '--text-dim':         'Dim Text',
      '--text-completed':   'Completed Text'
    };

    let customThemes = {};
    let editorOpen = false;
    let editingSlug = null;
    let liveVars = {};

    const loadCustomThemes = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.customThemes);
        if (raw) customThemes = JSON.parse(raw);
      } catch { customThemes = {}; }
    };

    const saveCustomThemes = () => {
      try { localStorage.setItem(STORAGE_KEYS.customThemes, JSON.stringify(customThemes)); } catch {}
    };

    const slugify = (name) => {
      return 'custom_' + name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '').substring(0, 30);
    };

    const isValidHex = (v) => /^#[0-9a-f]{6}$/i.test(v);

    const rgbToHex = (r, g, b) => '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');

    const parseColorToHex = (val) => {
      const s = String(val).trim().toLowerCase();
      if (isValidHex(s)) return s;
      if (/^#[0-9a-f]{3}$/i.test(s)) return '#' + s[1]+s[1] + s[2]+s[2] + s[3]+s[3];
      const temp = document.createElement('div');
      temp.style.color = s;
      document.body.appendChild(temp);
      const computed = getComputedStyle(temp).color;
      document.body.removeChild(temp);
      const m = computed.match(/(\d+)/g);
      if (m && m.length >= 3) return rgbToHex(+m[0], +m[1], +m[2]);
      return null;
    };

    const getCurrentVars = () => {
      const root = document.documentElement;
      const cs = getComputedStyle(root);
      const vars = {};
      for (const key of THEME_VARS) {
        const raw = cs.getPropertyValue(key).trim();
        const hex = parseColorToHex(raw);
        vars[key] = hex || '#000000';
      }
      return vars;
    };

    const previewVars = (vars) => {
      const root = document.documentElement;
      for (const [k, v] of Object.entries(vars)) root.style.setProperty(k, v);
    };

    const toast = (msg, duration = 2000) => {
      DOM.editorToast.textContent = msg;
      DOM.editorToast.classList.add('show');
      setTimeout(() => DOM.editorToast.classList.remove('show'), duration);
    };

    const buildColorRows = () => {
      DOM.colorRows.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const cssVar of THEME_VARS) {
        const label = VAR_LABELS[cssVar] || cssVar;
        const currentVal = liveVars[cssVar] || '#000000';
        const row = document.createElement('div');
        row.className = 'color-row';
        row.innerHTML = `
          <span class="color-row-label" title="${cssVar}">${escapeHTML(label)}</span>
          <div class="color-row-controls">
            <div class="color-picker-wrapper">
              <input type="color" value="${currentVal}" data-var="${cssVar}" aria-label="${label} color picker">
            </div>
            <input type="text" class="color-hex-input" value="${currentVal}" data-var="${cssVar}" maxlength="7" spellcheck="false" aria-label="${label} hex value">
          </div>
        `;
        const picker = row.querySelector('input[type="color"]');
        const hexInput = row.querySelector('.color-hex-input');

        picker.addEventListener('input', () => {
          const val = picker.value;
          hexInput.value = val;
          hexInput.classList.remove('invalid');
          liveVars[cssVar] = val;
          previewVars(liveVars);
        });

        hexInput.addEventListener('input', () => {
          let val = hexInput.value.trim();
          if (val && !val.startsWith('#')) val = '#' + val;
          const hex = parseColorToHex(val);
          if (hex) {
            hexInput.classList.remove('invalid');
            picker.value = hex;
            liveVars[cssVar] = hex;
            previewVars(liveVars);
          } else {
            hexInput.classList.add('invalid');
          }
        });

        hexInput.addEventListener('blur', () => {
          let val = hexInput.value.trim();
          if (val && !val.startsWith('#')) val = '#' + val;
          const hex = parseColorToHex(val);
          if (hex) {
            hexInput.value = hex;
            hexInput.classList.remove('invalid');
            picker.value = hex;
            liveVars[cssVar] = hex;
          } else {
            hexInput.value = liveVars[cssVar];
            hexInput.classList.remove('invalid');
          }
        });

        frag.appendChild(row);
      }
      DOM.colorRows.appendChild(frag);
    };

    const openEditor = (slug) => {
      editingSlug = slug || null;
      editorOpen = true;
      if (slug && customThemes[slug]) {
        liveVars = { ...customThemes[slug].vars };
        DOM.customThemeName.value = customThemes[slug].name;
      } else {
        liveVars = getCurrentVars();
        DOM.customThemeName.value = '';
      }
      previewVars(liveVars);
      buildColorRows();
      DOM.editorPanel.classList.add('open');
      DOM.editorIOArea.style.display = 'none';
      DOM.editorNewBtn.style.display = 'none';
      DOM.editorEditBtn.style.display = 'none';
    };

    const closeEditor = (revert = true) => {
      editorOpen = false;
      editingSlug = null;
      DOM.editorPanel.classList.remove('open');
      DOM.editorIOArea.style.display = 'none';
      DOM.editorNewBtn.style.display = '';
      updateEditButton();
      if (revert) {
        const saved = storageLoad(STORAGE_KEYS.theme, 'osrs');
        applyTheme(saved);
      }
    };

    const saveTheme = () => {
      const name = DOM.customThemeName.value.trim();
      if (!name) { toast('Please enter a theme name'); DOM.customThemeName.focus(); return; }
      for (const key of THEME_VARS) {
        if (!isValidHex(liveVars[key])) { toast(`Invalid color for ${VAR_LABELS[key] || key}`); return; }
      }
      const slug = editingSlug || slugify(name);
      if (!editingSlug && THEMES.hasOwnProperty(slug.replace('custom_', ''))) {
        toast('Name conflicts with a built-in theme'); return;
      }
      customThemes[slug] = { name: name, vars: { ...liveVars } };
      saveCustomThemes();
      refreshCustomDropdown();
      refreshCustomList();
      THEMES[slug] = { ...liveVars };
      applyTheme(slug);
      DOM.themeSel.value = slug;
      toast('Theme saved!');
      closeEditor(false);
    };

    const resetToBase = () => {
      const currentThemeKey = DOM.themeSel.value;
      if (editingSlug && customThemes[editingSlug]) {
        liveVars = { ...customThemes[editingSlug].vars };
      } else if (THEMES[currentThemeKey] && currentThemeKey !== editingSlug) {
        liveVars = { ...THEMES[currentThemeKey] };
      } else {
        applyTheme('osrs');
        liveVars = getCurrentVars();
      }
      previewVars(liveVars);
      buildColorRows();
      toast('Reset to base colors');
    };

    const deleteTheme = (slug) => {
      if (!customThemes[slug]) return;
      const name = customThemes[slug].name;
      delete customThemes[slug];
      delete THEMES[slug];
      saveCustomThemes();
      refreshCustomDropdown();
      refreshCustomList();
      const current = storageLoad(STORAGE_KEYS.theme, 'osrs');
      if (current === slug) { applyTheme('osrs'); DOM.themeSel.value = 'osrs'; }
      toast(`Deleted "${name}"`);
    };

    const exportTheme = () => {
      const name = DOM.customThemeName.value.trim() || 'Untitled';
      const data = { name: name, version: APP_VERSION, vars: { ...liveVars } };
      DOM.editorIOArea.value = JSON.stringify(data, null, 2);
      DOM.editorIOArea.style.display = 'block';
      DOM.editorIOArea.focus();
      DOM.editorIOArea.select();
      toast('Theme JSON exported');
    };

    const importTheme = () => {
      const area = DOM.editorIOArea;
      if (area.style.display === 'none') {
        area.style.display = 'block';
        area.value = '';
        area.placeholder = 'Paste theme JSON here, then click Import again...';
        area.focus();
        toast('Paste JSON then click Import again');
        return;
      }
      const raw = area.value.trim();
      if (!raw) { toast('Paste theme JSON first'); return; }
      try {
        const data = JSON.parse(raw);
        if (!data.vars || typeof data.vars !== 'object') { toast('Invalid theme format: missing vars'); return; }
        for (const key of THEME_VARS) {
          if (!data.vars[key]) { toast(`Missing color: ${VAR_LABELS[key] || key}`); return; }
          const hex = parseColorToHex(data.vars[key]);
          if (!hex) { toast(`Invalid color for ${VAR_LABELS[key] || key}`); return; }
          data.vars[key] = hex;
        }
        DOM.customThemeName.value = data.name || 'Imported Theme';
        liveVars = { ...data.vars };
        previewVars(liveVars);
        buildColorRows();
        area.style.display = 'none';
        toast('Theme imported! Click Save to keep it.');
      } catch (e) { toast('Invalid JSON format'); }
    };

    const refreshCustomDropdown = () => {
      DOM.customOptgroup.innerHTML = '';
      const slugs = Object.keys(customThemes).sort((a, b) => customThemes[a].name.localeCompare(customThemes[b].name));
      for (const slug of slugs) {
        const opt = document.createElement('option');
        opt.value = slug;
        opt.textContent = customThemes[slug].name;
        DOM.customOptgroup.appendChild(opt);
      }
      DOM.customOptgroup.style.display = slugs.length ? '' : 'none';
    };

    const refreshCustomList = () => {
      DOM.customThemeList.innerHTML = '';
      const slugs = Object.keys(customThemes).sort((a, b) => customThemes[a].name.localeCompare(customThemes[b].name));
      if (!slugs.length) {
        DOM.customThemeList.innerHTML = '<div style="font-size:0.75rem; color:var(--text-dim); padding:4px 0;">No custom themes yet</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      for (const slug of slugs) {
        const item = document.createElement('div');
        item.className = 'custom-theme-item';
        item.innerHTML = `
          <span class="custom-theme-item-name" data-slug="${slug}" title="Click to apply">${escapeHTML(customThemes[slug].name)}</span>
          <div class="custom-theme-item-actions">
            <button class="mini-btn edit-custom" data-slug="${slug}" aria-label="Edit ${escapeHTML(customThemes[slug].name)}">Edit</button>
            <button class="mini-btn del del-custom" data-slug="${slug}" aria-label="Delete ${escapeHTML(customThemes[slug].name)}">Del</button>
          </div>
        `;
        frag.appendChild(item);
      }
      DOM.customThemeList.appendChild(frag);
    };

    const updateEditButton = () => {
      const current = DOM.themeSel.value;
      DOM.editorEditBtn.style.display = customThemes[current] ? '' : 'none';
    };

    const registerAllCustom = () => {
      for (const [slug, data] of Object.entries(customThemes)) THEMES[slug] = { ...data.vars };
    };

    const init = () => {
      loadCustomThemes();
      registerAllCustom();
      refreshCustomDropdown();
      refreshCustomList();
      updateEditButton();

      DOM.editorNewBtn.addEventListener('click', () => openEditor(null));
      DOM.editorEditBtn.addEventListener('click', () => {
        const current = DOM.themeSel.value;
        if (customThemes[current]) openEditor(current);
      });
      DOM.editorSaveBtn.addEventListener('click', saveTheme);
      DOM.editorResetBtn.addEventListener('click', resetToBase);
      DOM.editorCancelBtn.addEventListener('click', () => closeEditor(true));
      DOM.editorExportBtn.addEventListener('click', exportTheme);
      DOM.editorImportBtn.addEventListener('click', importTheme);

      DOM.customThemeList.addEventListener('click', (e) => {
        const slug = e.target.dataset?.slug;
        if (!slug) return;
        if (e.target.classList.contains('custom-theme-item-name')) {
          THEMES[slug] = { ...customThemes[slug].vars };
          applyTheme(slug);
          DOM.themeSel.value = slug;
          updateEditButton();
        } else if (e.target.classList.contains('edit-custom')) {
          openEditor(slug);
        } else if (e.target.classList.contains('del-custom')) {
          if (confirm(`Delete "${customThemes[slug]?.name}"?`)) deleteTheme(slug);
        }
      });

      DOM.themeSel.addEventListener('change', () => updateEditButton());
    };

    return { init, refreshCustomDropdown, refreshCustomList, updateEditButton, closeEditor };
  })();

  /* ========================= EVENTS & INIT ========================= */
  function trapFocus(e) {
    if (!modalOpen || e.key !== 'Tab') return;
    const focusable = [...DOM.box.querySelectorAll('button,select,input,textarea,[tabindex]:not([tabindex="-1"])')]
      .filter(el => !el.disabled && el.offsetParent !== null);
    if (!focusable.length) return;
    const first = focusable[0], last = focusable[focusable.length - 1];
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  }

  function restartInterval() {
    if (syncIntervalId) clearInterval(syncIntervalId);
    syncIntervalId = setInterval(() => fetchData(false), syncMs);
  }

  async function init() {
    // Load shared config FIRST
    await loadSharedConfig();

    // Check if we came from admin page
    const params = new URLSearchParams(window.location.search);
    if (params.get('fromAdmin') === 'true') {
      const backBtn = $('admin-back-btn');
      if (backBtn) backBtn.style.display = 'flex';
    }

    const savedTheme = storageLoad(STORAGE_KEYS.theme, 'osrs');
    applyTheme(savedTheme);

    ThemeEditor.init();

    syncMs = parseInt(storageLoad(STORAGE_KEYS.syncInterval, String(eventConfig.syncInterval || 30000)), 10) || 30000;
    DOM.intervalSel.value = String(syncMs);

    miniNodes = Array.from({ length: maxTiles + 1 }, () => []);
    buildMinimap('minimap');
    buildMinimap('minimap-floating');

    fetchGlobal();
    setCodewordVisible(storageLoad(STORAGE_KEYS.codewordVisible, '0') === '1');

    // Event description
    renderEventDescription();
    if (DOM.descBarClose) {
      DOM.descBarClose.addEventListener('click', () => {
        DOM.descBar.style.display = 'none';
        try { sessionStorage.setItem('bingo-desc-dismissed', '1'); } catch {}
      });
    }

    // Codeword
    DOM.codeword.addEventListener('click', toggleCodeword);
    DOM.codeword.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCodeword(); }
    });

    // Minimap
    const wireMapOpen = (el) => {
      el.addEventListener('click', () => openMapModal(el));
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openMapModal(el); }
      });
    };
    wireMapOpen(DOM.miniDash);
    wireMapOpen(DOM.miniFloat);

    // Big map tiles
    DOM.bigMap.addEventListener('click', (e) => {
      const cell = e.target.closest('.large-map-tile');
      if (!cell) return;
      const id = parseInt(cell.dataset.index, 10);
      if (!id) return;
      openTileModalByIndex(id - 1, cell);
    });

    DOM.bigMap.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter' && e.key !== ' ') return;
      const cell = e.target.closest('.large-map-tile');
      if (!cell) return;
      e.preventDefault();
      const id = parseInt(cell.dataset.index, 10);
      if (!id) return;
      openTileModalByIndex(id - 1, cell);
    });

    // Settings
    DOM.settingsTrigger.addEventListener('click', () => openSettingsModal(DOM.settingsTrigger));

    // Theme dropdown change
    DOM.themeSel.addEventListener('change', () => {
      const name = DOM.themeSel.value;
      applyTheme(name);
      ThemeEditor.updateEditButton();
      ThemeEditor.closeEditor(false);
    });

    // Sync interval change
    DOM.intervalSel.addEventListener('change', () => {
      syncMs = parseInt(DOM.intervalSel.value, 10) || 30000;
      storageSave(STORAGE_KEYS.syncInterval, syncMs);
      restartInterval();
    });

    // Modal close
    DOM.overlay.addEventListener('click', (e) => { if (e.target === DOM.overlay) closeModal(); });
    document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));

    // Map back button
    DOM.mapBack.addEventListener('click', () => {
      DOM.box.classList.remove('completed');
      if (ghostEl?.isConnected) ghostEl.classList.remove('ghost');
      ghostEl = null;
      hideViews();
      DOM.viewMap.style.display = 'flex';
      buildBigMap();
    });

    // Sync now
    DOM.syncNow.addEventListener('click', () => fetchData(true));
    DOM.syncNow.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fetchData(true); }
    });

    // Keyboard
    document.addEventListener('keydown', (e) => {
      if (modalOpen && e.key === 'Escape') closeModal();
      trapFocus(e);
    });

    // Visibility
    document.addEventListener('visibilitychange', async () => {
      if (document.hidden) {
        if (syncIntervalId) clearInterval(syncIntervalId);
        syncIntervalId = null;
      } else {
        await loadSharedConfig();
        const savedTheme = storageLoad(STORAGE_KEYS.theme, 'osrs');
        applyTheme(savedTheme);
        fetchGlobal();
        restartInterval();
        fetchData(false);
      }
    });

    fetchData(false);
    restartInterval();
  }

  init();
})();
  </script>
</body>
</html>